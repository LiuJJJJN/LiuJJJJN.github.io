<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">SpringCloud自学笔记md版 - LiuJN 的个人博客</title><meta name="Description" content="This is LiuJN"><meta property="og:title" content="SpringCloud自学笔记md版" />
<meta property="og:description" content="SpringCloud 自学笔记 大连交通大学 信息学院 刘嘉宁 笔记摘自 尚硅谷 什么是 SpringCloud 最早是由奶飞公司提出的分布式解决方案，后来被 Spring 公司抄了作业 所有请求都由 服务网关 通过" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liujjjjn.github.io/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88/" /><meta property="og:image" content="https://liujjjjn.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-14T00:00:00+08:00" />
<meta property="article:modified_time" content="2023-04-14T00:00:00+08:00" /><meta property="og:site_name" content="刘嘉宁的个人博客" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://liujjjjn.github.io/logo.png"/>

<meta name="twitter:title" content="SpringCloud自学笔记md版"/>
<meta name="twitter:description" content="SpringCloud 自学笔记 大连交通大学 信息学院 刘嘉宁 笔记摘自 尚硅谷 什么是 SpringCloud 最早是由奶飞公司提出的分布式解决方案，后来被 Spring 公司抄了作业 所有请求都由 服务网关 通过"/>
<meta name="application-name" content="LiuJN">
<meta name="apple-mobile-web-app-title" content="LiuJN">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://liujjjjn.github.io/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88/" /><link rel="prev" href="https://liujjjjn.github.io/rms%E6%8B%9B%E8%81%98%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "SpringCloud自学笔记md版",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/liujjjjn.github.io\/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88\/"
        },"genre": "posts","wordcount":  28661 ,
        "url": "https:\/\/liujjjjn.github.io\/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88\/","datePublished": "2023-04-14T00:00:00+08:00","dateModified": "2023-04-14T00:00:00+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "刘嘉宁"
            },"description": ""
    }
    </script></head>

<body header-desktop="auto" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LiuJN 的个人博客">刘嘉宁的个人博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LiuJN 的个人博客">刘嘉宁的个人博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a href="#" onclick="return false;" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "false")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">SpringCloud自学笔记md版</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="https://liujjjjn.github.io/" title="Author" target="_blank" rel="noopener noreffer author" class="author">刘嘉宁</a>
                </span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-04-14">2023-04-14</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2023-04-14">2023-04-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 28661 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 58 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="true">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#什么是-springcloud">什么是 SpringCloud</a></li>
    <li><a href="#什么是分布式什么是微服务">什么是分布式、什么是微服务</a>
      <ul>
        <li><a href="#什么是分布式">什么是分布式</a></li>
        <li><a href="#什么是微服务">什么是微服务</a></li>
        <li><a href="#两者的区别">两者的区别</a></li>
      </ul>
    </li>
    <li><a href="#微服务架构的优缺点">微服务架构的优缺点</a></li>
    <li><a href="#boot-和-cloud-版本对应关系">Boot 和 Cloud 版本对应关系</a></li>
    <li><a href="#springcloud-组件的变更">SpringCloud 组件的变更</a></li>
    <li><a href="#创建-springcloud-工程">创建 SpringCloud 工程</a>
      <ul>
        <li><a href="#什么是-resttemplate">什么是 RestTemplate</a></li>
        <li><a href="#如何导入团队自己的工具包">如何导入团队自己的工具包</a></li>
        <li><a href="#springboot-一般通用配置-pomxml">SpringBoot 一般通用配置 pom.xml</a></li>
      </ul>
    </li>
    <li><a href="#eureka-服务注册与发现维护">Eureka 服务注册与发现【维护】</a>
      <ul>
        <li><a href="#什么是服务治理">什么是服务治理</a></li>
        <li><a href="#什么是服务发现与注册">什么是服务发现与注册</a></li>
        <li><a href="#搭建-eureka-工程">搭建 Eureka 工程</a>
          <ul>
            <li><a href="#创建-eureka-server-工程步骤">创建 Eureka Server 工程步骤</a></li>
            <li><a href="#修改-eureka-client-工程步骤">修改 Eureka Client 工程步骤</a></li>
            <li><a href="#搭建-eureka-注册中心集群">搭建 Eureka 注册中心集群</a></li>
            <li><a href="#搭建-生产者-集群">搭建 生产者 集群</a></li>
          </ul>
        </li>
        <li><a href="#信息功能完善及修改">信息功能完善及修改</a></li>
        <li><a href="#服务发现-discovery">服务发现 Discovery</a></li>
        <li><a href="#eureka-的自我保护机制">Eureka 的自我保护机制</a>
          <ul>
            <li><a href="#如何关闭自我保护机制">如何关闭自我保护机制</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#zookeeper-服务注册与发现">Zookeeper 服务注册与发现</a>
      <ul>
        <li><a href="#临时节点-or-持久节点">临时节点 or 持久节点</a></li>
        <li><a href="#搭建-zookeeper-工程">搭建 Zookeeper 工程</a>
          <ul>
            <li><a href="#创建-zookeeper-生产者步骤">创建 Zookeeper 生产者步骤</a></li>
            <li><a href="#创建-zookeeper-消费者步骤">创建 Zookeeper 消费者步骤</a></li>
            <li><a href="#zookeeper-注册中心集群">Zookeeper 注册中心集群</a></li>
            <li><a href="#遇到的问题依赖冲突">遇到的问题：依赖冲突</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#consul-服务注册与发现">Consul 服务注册与发现</a>
      <ul>
        <li><a href="#搭建-consul-工程">搭建 Consul 工程</a>
          <ul>
            <li><a href="#创建-consul-生产者步骤">创建 Consul 生产者步骤</a></li>
            <li><a href="#创建-consul-消费者步骤">创建 Consul 消费者步骤</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#服务注册与发现-三者的异同">服务注册与发现 三者的异同</a>
      <ul>
        <li><a href="#什么是-cap">什么是 CAP</a></li>
      </ul>
    </li>
    <li><a href="#ribbon-负载均衡服务调用维护">Ribbon 负载均衡服务调用【维护】</a>
      <ul>
        <li><a href="#什么是负载均衡">什么是负载均衡</a></li>
        <li><a href="#ribbon-与-nginx-的区别">Ribbon 与 Nginx 的区别</a></li>
        <li><a href="#ribbon-的工作流程">Ribbon 的工作流程</a></li>
        <li><a href="#重温-resttemplate">重温 RestTemplate</a></li>
        <li><a href="#ribbon-提供的-irule-接口">Ribbon 提供的 IRule 接口</a></li>
        <li><a href="#更换-ribbon-负载均衡规则">更换 Ribbon 负载均衡规则</a></li>
        <li><a href="#ribbon-轮询负载均衡原理">Ribbon 轮询负载均衡原理</a></li>
        <li><a href="#手写轮询算法">手写轮询算法</a></li>
      </ul>
    </li>
    <li><a href="#openfeign-服务接口调用">OpenFeign 服务接口调用</a>
      <ul>
        <li><a href="#什么是-feignopenfeign">什么是 Feign、OpenFeign</a></li>
        <li><a href="#搭建-openfeign-工程">搭建 OpenFeign 工程</a></li>
        <li><a href="#feign-的超时控制">Feign 的超时控制</a></li>
        <li><a href="#feign-的日志增强">Feign 的日志增强</a></li>
      </ul>
    </li>
    <li><a href="#hystrix-断路器维护">Hystrix 断路器【维护】</a>
      <ul>
        <li><a href="#服务降级-解决什么问题">服务降级 解决什么问题</a></li>
        <li><a href="#什么是-hystrix">什么是 Hystrix</a></li>
        <li><a href="#服务降级-相关概念">服务降级 相关概念</a></li>
        <li><a href="#搭建-hystrix-工程">搭建 Hystrix 工程</a>
          <ul>
            <li><a href="#高并发测试">高并发测试</a></li>
          </ul>
        </li>
        <li><a href="#服务降级-的情况">服务降级 的情况</a></li>
        <li><a href="#在生产者端-服务降级配置">在生产者端 服务降级配置</a></li>
        <li><a href="#在消费者端-服务降级配置">在消费者端 服务降级配置</a></li>
        <li><a href="#遇到的问题-a-idhystrixproblem-a">遇到的问题 <a id='HystrixProblem'> </a></a></li>
        <li><a href="#服务熔断-的情况">服务熔断 的情况</a></li>
        <li><a href="#在生产者端-服务熔断配置">在生产者端 服务熔断配置</a></li>
        <li><a href="#服务限流-的情况">服务限流 的情况</a></li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#hystrix-的-dashboard-仪表盘">Hystrix 的 dashboard 仪表盘</a></li>
      </ul>
    </li>
    <li><a href="#zuul-服务网关">Zuul 服务网关</a>
      <ul>
        <li><a href="#什么是服务网关">什么是服务网关</a></li>
      </ul>
    </li>
    <li><a href="#gateway-服务网关">Gateway 服务网关</a>
      <ul>
        <li><a href="#gateway-的特性">Gateway 的特性</a></li>
        <li><a href="#gateway-的核心概念">Gateway 的核心概念</a></li>
        <li><a href="#gateway-工作流程">Gateway 工作流程</a></li>
        <li><a href="#搭建-gateway-工程">搭建 Gateway 工程</a>
          <ul>
            <li><a href="#第二种配置方式">第二种配置方式</a></li>
            <li><a href="#实现动态路由">实现动态路由</a></li>
          </ul>
        </li>
        <li><a href="#断言-predicate-的使用">断言 Predicate 的使用</a></li>
        <li><a href="#过滤器-filter-的使用">过滤器 Filter 的使用</a></li>
      </ul>
    </li>
    <li><a href="#config-分布式服务配置">Config 分布式服务配置</a>
      <ul>
        <li><a href="#搭建服务端配置">搭建服务端配置</a></li>
        <li><a href="#配置读取规则">配置读取规则</a></li>
        <li><a href="#搭建客户端配置">搭建客户端配置</a></li>
        <li><a href="#配置动态刷新问题">配置动态刷新问题</a></li>
      </ul>
    </li>
    <li><a href="#bus-消息总线">Bus 消息总线</a>
      <ul>
        <li><a href="#什么是-总线">什么是 总线</a></li>
        <li><a href="#配置-bus-工程实现全局广播">配置 Bus 工程实现全局广播</a></li>
        <li><a href="#配置-bus-工程实现定点通知">配置 Bus 工程实现定点通知</a></li>
        <li><a href="#总结-1">总结</a></li>
      </ul>
    </li>
    <li><a href="#stream-消息驱动">Stream 消息驱动</a>
      <ul>
        <li><a href="#springcloud-stream-的设计思想">SpringCloud Stream 的设计思想</a></li>
        <li><a href="#搭建-stream-工程">搭建 Stream 工程</a>
          <ul>
            <li><a href="#搭建消息生产者-8801-模块">搭建消息生产者 8801 模块</a></li>
            <li><a href="#搭建消息消费者-88028803-模块">搭建消息消费者 8802、8803 模块</a></li>
          </ul>
        </li>
        <li><a href="#重复消费">重复消费</a></li>
        <li><a href="#消息持久化">消息持久化</a></li>
      </ul>
    </li>
    <li><a href="#sleuth-分布式链路追踪">Sleuth 分布式链路追踪</a>
      <ul>
        <li><a href="#如何使用">如何使用</a></li>
        <li><a href="#搭建链路追踪步骤">搭建链路追踪步骤</a></li>
      </ul>
    </li>
    <li><a href="#springcloud-alibaba-部分">SpringCloud Alibaba 部分</a>
      <ul>
        <li><a href="#springcloud-alibaba-能干什么">SpringCloud Alibaba 能干什么</a></li>
        <li><a href="#nacos-作为服务注册">Nacos 作为服务注册</a>
          <ul>
            <li><a href="#安装-nacos">安装 Nacos</a></li>
            <li><a href="#搭建-nacos-工程">搭建 Nacos 工程</a>
              <ul>
                <li><a href="#配置服务生产者">配置服务生产者</a></li>
                <li><a href="#配置服务生产者2">配置服务生产者2</a></li>
                <li><a href="#配置服务消费者">配置服务消费者</a>
                  <ul>
                    <li><a href="#使用-feign">使用 Feign</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#ap-or-cp">AP or CP</a></li>
            <li><a href="#与其他注册中心特性对比">与其他注册中心特性对比</a></li>
          </ul>
        </li>
        <li><a href="#nacos-作为配置中心">Nacos 作为配置中心</a>
          <ul>
            <li><a href="#搭建-nacos-工程-1">搭建 Nacos 工程</a></li>
            <li><a href="#配置规则公式">配置规则公式</a></li>
            <li><a href="#分类配置">分类配置</a>
              <ul>
                <li><a href="#data-id-方案">Data ID 方案</a></li>
                <li><a href="#group-方案">Group 方案</a></li>
                <li><a href="#namespace-方案">Namespace 方案</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#nacos-集群和持久化配置">Nacos 集群和持久化配置</a>
          <ul>
            <li><a href="#单机模式支持-mysql">单机模式支持 MySQL</a></li>
            <li><a href="#linux-集群生产环境配置">Linux 集群生产环境配置</a></li>
          </ul>
        </li>
        <li><a href="#sentinel-熔断与限流">Sentinel 熔断与限流</a>
          <ul>
            <li><a href="#运行-sentinel">运行 Sentinel</a></li>
            <li><a href="#搭建-sentinel-工程">搭建 Sentinel 工程</a></li>
            <li><a href="#流控规则流量控制规则">流控规则（流量控制规则）</a>
              <ul>
                <li><a href="#直接">直接</a></li>
                <li><a href="#关联">关联</a></li>
                <li><a href="#链路">链路</a></li>
                <li><a href="#快速失败">快速失败</a></li>
                <li><a href="#warm-up预热--冷启动">Warm Up（预热 / 冷启动）</a></li>
                <li><a href="#匀速排队">匀速排队</a></li>
              </ul>
            </li>
            <li><a href="#降级规则熔断降级规则">降级规则（熔断降级规则）</a>
              <ul>
                <li><a href="#rt-慢调用比例">RT 慢调用比例</a></li>
                <li><a href="#异常比例">异常比例</a></li>
                <li><a href="#异常数">异常数</a></li>
              </ul>
            </li>
            <li><a href="#热点规则热点-key-限流">热点规则（热点 Key 限流）</a>
              <ul>
                <li><a href="#参数例外项">参数例外项</a></li>
                <li><a href="#异常情况">异常情况</a></li>
              </ul>
            </li>
            <li><a href="#系统规则">系统规则</a>
              <ul>
                <li><a href="#全局-qps">全局 QPS</a></li>
              </ul>
            </li>
            <li><a href="#sentinelresource-注解">@SentinelResource 注解</a>
              <ul>
                <li><a href="#按-资源名称-限流--后续处理">按 资源名称 限流 + 后续处理</a></li>
                <li><a href="#按照-url-地址限流--后续处理">按照 URL 地址限流 + 后续处理</a></li>
                <li><a href="#遇到问题">遇到问题</a></li>
                <li><a href="#自定义限流处理逻辑">自定义限流处理逻辑</a></li>
                <li><a href="#sentinelresource-注解其他属性">@SentinelResource 注解其他属性</a></li>
              </ul>
            </li>
            <li><a href="#服务熔断">服务熔断</a>
              <ul>
                <li><a href="#使用-resttemplate">使用 RestTemplate</a></li>
                <li><a href="#使用-feign-1">使用 Feign</a></li>
              </ul>
            </li>
            <li><a href="#常见熔断框架比较">常见熔断框架比较</a></li>
            <li><a href="#规则持久化">规则持久化</a></li>
          </ul>
        </li>
        <li><a href="#seata-事务">Seata 事务</a>
          <ul>
            <li><a href="#seata-术语">Seata 术语</a></li>
            <li><a href="#seata-的安装部署">Seata 的安装部署</a></li>
            <li><a href="#搭建-seata-工程">搭建 Seata 工程</a></li>
            <li><a href="#验证-seata-工程">验证 Seata 工程</a></li>
            <li><a href="#seata-原理简介">Seata 原理简介</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="springcloud-自学笔记" class="headerLink">
    <a href="#springcloud-%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0" class="header-mark"></a>SpringCloud 自学笔记</h1><blockquote>
<p>大连交通大学 信息学院 刘嘉宁</p>
<p>笔记摘自 尚硅谷</p>
</blockquote>
<h2 id="什么是-springcloud" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-springcloud" class="header-mark"></a>什么是 SpringCloud</h2><ul>
<li>最早是由奶飞公司提出的分布式解决方案，后来被 Spring 公司抄了作业</li>
<li>所有请求都由 <code>服务网关</code> 通过 <code>服务注册和发现</code> 根据 <code>配置中心</code> 找到对应的 SpringBoot 服务模块进行协调和调度</li>
<li>如果有<code>容错</code> 和 <code>限流</code> 比如 <code>降级</code>、<code>熔断</code> 进行服务监控、健康检查和报警</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230308131446098.png" alt="image-20230308131446098" style="zoom: 67%;" />
<ul>
<li>是分布式微服务架构的一站式解决方案</li>
<li>是多种微服务架构落地技术的集合体</li>
<li>是一系列技术的集合，俗称微服务全家桶</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230308131635484.png" alt="image-20230308131635484" style="zoom: 25%;" />
<h2 id="什么是分布式什么是微服务" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e5%88%86%e5%b8%83%e5%bc%8f%e4%bb%80%e4%b9%88%e6%98%af%e5%be%ae%e6%9c%8d%e5%8a%a1" class="header-mark"></a>什么是分布式、什么是微服务</h2><h3 id="什么是分布式" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e5%88%86%e5%b8%83%e5%bc%8f" class="header-mark"></a>什么是分布式</h3><ul>
<li>分布式系统就是把所有的程序、功能拆分成不同的子系统，部署在多台不同的服务器上</li>
<li>这些子系统相互协作共同对外提供服务，而对用户而言他并不知道后台是多个子系统和多台服务器在提供服务，在使用上和集中式系统一样</li>
</ul>
<h3 id="什么是微服务" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e5%be%ae%e6%9c%8d%e5%8a%a1" class="header-mark"></a>什么是微服务</h3><ul>
<li>微服务是系统架构上的一种<strong>设计风格</strong>， 它的主旨是将一个原本独立的系统拆分成多个小型服务</li>
<li>这些小型服务都在各自独立的进程中运行，服务之间通过基于 HTTP 的 RESTful API 进行通信协作</li>
<li>被拆分后的每一个小型服务都围绕着系统中的某一项业务功能进行构建， 并且每个服务都是一个独立的项目，可以进行独立的测试、开发和部署等</li>
<li>由于各个独立的服务之间使用的是基于 HTTP 的作为数据通信协作的基础，所以这些微服务可以使用不同的语言来开发</li>
</ul>
<h3 id="两者的区别" class="headerLink">
    <a href="#%e4%b8%a4%e8%80%85%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-mark"></a>两者的区别</h3><ul>
<li>分布式强调系统的拆分，微服务也是强调系统的拆分，<strong>微服务架构属于分布式架构的范畴</strong></li>
</ul>
<h2 id="微服务架构的优缺点" class="headerLink">
    <a href="#%e5%be%ae%e6%9c%8d%e5%8a%a1%e6%9e%b6%e6%9e%84%e7%9a%84%e4%bc%98%e7%bc%ba%e7%82%b9" class="header-mark"></a>微服务架构的优缺点</h2><p>优点：</p>
<ul>
<li>将系统中的不同功能模块拆分成多个不同的服务，独立地开发和部署，都运行在自己的进程内，每个服务的更新<strong>都不影响其他服务的运行</strong></li>
<li>由于是独立部署的，可以<strong>更准确地监控</strong>每个服务的资源消耗情况，进行性能容量的评估，通过压力测试，也很容易发现各个服务间的性能瓶颈所在</li>
<li>独立开发比较方便，减少代码的冲突、代码的重复，<strong>逻辑更加清晰</strong>，易于后续的维护与扩展</li>
<li>可以<strong>使用不同的编程语言</strong>进行开发</li>
</ul>
<p>缺点：</p>
<ul>
<li>微服务架构增加了系统维护、部署的难度，导致一些功能模块或代码无法复用</li>
<li>随着系统规模的日渐增长，微服务在一定程度上也会导致系统变得越来越复杂，增加了集成测试的复杂度</li>
<li>随着微服务的增多，数据的一致性问题，服务之间的通信成本等都凸显了出来</li>
</ul>
<h2 id="boot-和-cloud-版本对应关系" class="headerLink">
    <a href="#boot-%e5%92%8c-cloud-%e7%89%88%e6%9c%ac%e5%af%b9%e5%ba%94%e5%85%b3%e7%b3%bb" class="header-mark"></a>Boot 和 Cloud 版本对应关系</h2><ul>
<li>SpringCloud 使用伦敦地铁站命名其版本，Axxx ~ Zxxx (目前 Kilburn 3.0.x)</li>
<li>每当重大 BUG 被修复，就会发布一个 SR (Server Releases 版本) 2021年 Hoxton.SR12 第十二个版本</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230309130434111.png" alt="image-20230309130434111" style="zoom: 67%;" />
<ul>
<li>2020 年开始强烈推荐升级到 SpringCloud 2.0 以上版本</li>
<li>SpringCloud 官网版本对应推荐 <a href="https://start.spring.io/actuator/info" target="_blank" rel="noopener noreffer">https://start.spring.io/actuator/info</a></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230309125532313.png" alt="image-20230309125532313" style="zoom: 80%;" />
<ul>
<li>在 SpringCloud 官网 LEARN 标签中查看推荐的对应 Boot 版本</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230309131211504.png" alt="image-20230309131211504" style="zoom: 50%;" />
<h2 id="springcloud-组件的变更" class="headerLink">
    <a href="#springcloud-%e7%bb%84%e4%bb%b6%e7%9a%84%e5%8f%98%e6%9b%b4" class="header-mark"></a>SpringCloud 组件的变更</h2><img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678254326877-3.png" alt="img" style="zoom: 50%;" />
<h2 id="创建-springcloud-工程" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba-springcloud-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>创建 SpringCloud 工程</h2><ul>
<li>编程风格：<strong>约定 &gt; 配置 &gt; 编码</strong></li>
<li>创建详情见 angenin 的博客笔记 <a href="https://blog.csdn.net/qq_36903261/article/details/106507150" target="_blank" rel="noopener noreffer">SpringCloud(H版&amp;Alibaba)技术（1-4基础入门，创建项目）CSDN博客</a></li>
</ul>
<h3 id="什么是-resttemplate" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-resttemplate" class="header-mark"></a>什么是 RestTemplate</h3><ul>
<li>RestTemplate 是一个同步的 web http 客户端请求模板工具</li>
<li>它封装了<code>http</code>连接, 可以向一个 REST 接口发送请求并获取响应</li>
</ul>
<ol>
<li><code>postForObject</code> 请求地址，请求参数，返回的对象类型</li>
<li><code>getForObject</code> 请求地址，返回的对象类型</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230309202153960.png" alt="image-20230309202153960" style="zoom: 80%;" />
<h3 id="如何导入团队自己的工具包" class="headerLink">
    <a href="#%e5%a6%82%e4%bd%95%e5%af%bc%e5%85%a5%e5%9b%a2%e9%98%9f%e8%87%aa%e5%b7%b1%e7%9a%84%e5%b7%a5%e5%85%b7%e5%8c%85" class="header-mark"></a>如何导入团队自己的工具包</h3><ul>
<li>在一个项目中创建多个模块，其中一个专门用来做工具包模块</li>
<li>将自己团队写的 commons 模块使用 maven install 到自己本地仓库中</li>
<li>在需要的模块的 pom 文件中导入工具模块的依赖，实现一处修改处处应用</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230309205304736.png" alt="image-20230309205304736" style="zoom: 80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230309205621812.png" alt="image-20230309205621812" style="zoom:80%;" />
<h3 id="springboot-一般通用配置-pomxml" class="headerLink">
    <a href="#springboot-%e4%b8%80%e8%88%ac%e9%80%9a%e7%94%a8%e9%85%8d%e7%bd%ae-pomxml" class="header-mark"></a>SpringBoot 一般通用配置 pom.xml</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- 一般通用配置 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringBoot WEB 启动依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringBoot 测试启动依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringBoot 热部署依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-devtools<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- lombok 注解开发 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="eureka-服务注册与发现维护" class="headerLink">
    <a href="#eureka-%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%8e%e5%8f%91%e7%8e%b0%e7%bb%b4%e6%8a%a4" class="header-mark"></a>Eureka 服务注册与发现【维护】</h2><h3 id="什么是服务治理" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%9c%8d%e5%8a%a1%e6%b2%bb%e7%90%86" class="header-mark"></a>什么是服务治理</h3><ul>
<li>在传统 RPC 远程调用框架中，管理每个服务与服务之间依赖关系比较复杂</li>
<li>服务治理就是实现服务调用、负载均衡、容错等，实现服务发现与注册</li>
</ul>
<h3 id="什么是服务发现与注册" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0%e4%b8%8e%e6%b3%a8%e5%86%8c" class="header-mark"></a>什么是服务发现与注册</h3><ul>
<li>
<p>在 RPC 远程调用框架核心设计思想在于<strong>注册中心</strong>, 使用注册中心 (存放服务地址相关信息 (接口地址) ) 管理每个服务与服务之间的一个依赖关系【服务治理】</p>
</li>
<li>
<p>当服务器启动的时候，会把当前自己服务器的信息 (服务地址、通信地址) 等以别名方式注册到注册中心上，消费者/服务提供者 以该别名的方式去注册中心上获取到实际的服务通信地址，然后再实现 RPC 调用</p>
</li>
<li>
<p>Eureka 从用 C/S 的设计架构，Eureka Server 作为注册中心，其它微服务使用 Eureka 客户端连接到注册中心并维持心跳连接，维护人员通过 Eureka Server 来监控系统中各个微服务是否运行正常</p>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310130544101.png" alt="image-20230310130544101" style="zoom: 28%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230310125349524.png" alt="image-20230310125349524" style="zoom: 33%;" />
<h3 id="搭建-eureka-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-eureka-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Eureka 工程</h3><h4 id="创建-eureka-server-工程步骤" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba-eureka-server-%e5%b7%a5%e7%a8%8b%e6%ad%a5%e9%aa%a4" class="header-mark"></a>创建 Eureka Server 工程步骤</h4><ol>
<li>添加 pom 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- eureka-server --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 监控 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 引用自己定义的 api 通用包，可以使用 Payment 支付 Entity --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.atguigu.springcloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 一般通用配置 --&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>配置 application.yml</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">7001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">localhost </span><span class="w"> </span><span class="c"># eureka服务端的实例名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># false 表示不向注册中心注册自己（想注册也可以，不过没必要）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># false 表示自己端就是注册中心，职责就是维护服务实例，并不需要去 检索服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 设置与 eurekaServer 交互的地址查询服务和注册服务都需要依赖这个地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://${eureka.instance.hostname}:${server.port}/eureka/</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>在启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaServer</span> <span class="c1">// 标识此工程是 Eureka Server 服务注册中心
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EurekaMain7001</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">EurekaMain7001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>访问 <code>localhost:7001</code>
<ul>
<li>看到 application 为空的，因为此时还没有其它项目注册进来</li>
</ul>
</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230310141538817.png" alt="image-20230310141538817" style="zoom: 67%;" />
<h4 id="修改-eureka-client-工程步骤" class="headerLink">
    <a href="#%e4%bf%ae%e6%94%b9-eureka-client-%e5%b7%a5%e7%a8%8b%e6%ad%a5%e9%aa%a4" class="header-mark"></a>修改 Eureka Client 工程步骤</h4><ol>
<li>添加 Eureka Client 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">         <span class="c">&lt;!-- eureka-client --&gt;</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">             <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在 application.yml 中添加</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 此微服务项目的别名就是上面配置的 spring.application.name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># true 表示向注册中心注册自己，默认为 true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 是否从 EurekaServer 抓取已有的注册信息，默认为 true。单节点无所谓，集群必须设置为 true 才能配合 ribbon 使用负载均衡</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>在启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>访问 <code>localhost:7001</code>
<ul>
<li>看到 application 已经有项目注册进来了<strong>applicaiton 的项目名就是在 yml 中配置的 spring.application.name 名称</strong></li>
</ul>
</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230310143157663.png" alt="image-20230310143157663" style="zoom:67%;" />
<h4 id="搭建-eureka-注册中心集群" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-eureka-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e9%9b%86%e7%be%a4" class="header-mark"></a>搭建 Eureka 注册中心集群</h4><img src="SpringCloud自学笔记md版.assets/image-20230310145816273.png" alt="image-20230310145816273" style="zoom:67%;" />
<ul>
<li>为避免单一注册中心突然宕机导致整体项目不可用，搭建注册中心集群实现 <strong>负载均衡</strong>、<strong>故障容错</strong></li>
<li>Eureka 注册中心集群：相互注册，相互守望</li>
</ul>
<ol>
<li>修改 hosts 文件，添加</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 以下为 SpringCloud Eureka 注册中心集群配置
</span></span><span class="line"><span class="cl">127.0.0.1       eureka7001.com
</span></span><span class="line"><span class="cl">127.0.0.1       eureka7002.com
</span></span><span class="line"><span class="cl">127.0.0.1		eureka7003.com
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>修改两个注册中心的 yml 配置文件
<ul>
<li>hostname 和 defaultZone 首尾相连，7001 注册 7002，7002 注册 7001</li>
<li>如果是三台互相映射，那么 defaultZone 应写两个地址中间逗号分隔</li>
</ul>
</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230310152753531.png" alt="image-20230310152753531" style="zoom:80%;" />
<ol start="3">
<li>访问测试</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230310154050176.png" alt="image-20230310154050176" style="zoom: 67%;" />
<ol start="4">
<li>修改生产者和消费者模块的 yml</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">      </span><span class="c">#集群版</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001:7001/eureka/,http://eureka7002:7002/eureka/</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>启动顺序</p>
<ol>
<li>先启动 Eureka 注册中心集群</li>
<li>启动生产者服务</li>
<li>启动消费者服务</li>
</ol>
</blockquote>
<h4 id="搭建-生产者-集群" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-%e7%94%9f%e4%ba%a7%e8%80%85-%e9%9b%86%e7%be%a4" class="header-mark"></a>搭建 生产者 集群</h4><ul>
<li>根据原有生产者复制出一份</li>
<li>使用相同的微服务名，修改端口地址</li>
<li>可以看到注册中心中生产者有两个</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310173404750.png" alt="image-20230310173404750" style="zoom:80%;" />
<ul>
<li>修改 消费者 连接地址为 生产者服务名</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310174125851.png" alt="image-20230310174125851" style="zoom:80%;" />
<ul>
<li>开启 RestTemplate 的负载均衡功能 <a id='RestTemplateConfig'></a></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310174258204.png" alt="image-20230310174258204" style="zoom:80%;" />
<ul>
<li>Ribbon 默认为轮询的负载均衡策略，一次访问 8001 一次访问 8002</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310191717627.png" alt="image-20230310191717627" style="zoom:80%;" />
<h3 id="信息功能完善及修改" class="headerLink">
    <a href="#%e4%bf%a1%e6%81%af%e5%8a%9f%e8%83%bd%e5%ae%8c%e5%96%84%e5%8f%8a%e4%bf%ae%e6%94%b9" class="header-mark"></a>信息功能完善及修改</h3><ul>
<li>
<p>服务名称修改</p>
  <img src="SpringCloud自学笔记md版.assets/image-20230310192118633.png" alt="image-20230310192118633" style="zoom: 67%;" />
<ul>
<li>为生产者添加 eureka.instance.instance-id 属性值</li>
</ul>
  <img src="SpringCloud自学笔记md版.assets/image-20230310192259562.png" alt="image-20230310192259562" style="zoom:80%;" />
</li>
<li>
<p>添加访问路径 IP 信息</p>
  <img src="SpringCloud自学笔记md版.assets/image-20230310192517303.png" alt="image-20230310192517303" style="zoom:80%;" />
<ul>
<li>在生产者配置 yml 中添加 eureka.instance.prefer-ip-address 属性值为 true</li>
</ul>
  <img src="SpringCloud自学笔记md版.assets/image-20230310192643001.png" alt="image-20230310192643001" style="zoom:80%;" />
</li>
</ul>
<h3 id="服务发现-discovery" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0-discovery" class="header-mark"></a>服务发现 Discovery</h3><ul>
<li>通过 服务发现 来获取 Eureka 中现有微服务的信息</li>
</ul>
<ol>
<li>为微服务注入 DiscoveryClient</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">	<span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DiscoveryClient</span> <span class="n">discoveryClient</span><span class="o">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>通过其 <code>getServices()</code>、<code>discoveryClient.getInstances(&quot;服务名&quot;)</code> 可以获取到对应服务的一些基本信息</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230310194448762.png" alt="image-20230310194448762" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述" style="zoom:80%;" />
<h3 id="eureka-的自我保护机制" class="headerLink">
    <a href="#eureka-%e7%9a%84%e8%87%aa%e6%88%91%e4%bf%9d%e6%8a%a4%e6%9c%ba%e5%88%b6" class="header-mark"></a>Eureka 的自我保护机制</h3><ul>
<li>在一组客户端与 eureka server 存在网络分区时会自动开启保护，会保护服务注册表中的信息，不会删除注册表中的信息，不会注销任何微服务</li>
<li>出现这一行红字就是保护模式，这属于 CAP 中的 AP 分支</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310195012903.png" alt="image-20230310195012903" style="zoom: 67%;" />
<ul>
<li>默认情况下 Eureka Server 在一定时间内没有收到某个微服务实例的心跳，将会注销该实例（默认 90 秒）</li>
<li>但是因为网络卡顿、延时、拥挤时，微服务还是健康的，此时并不应该删除该微服务【高可用，健壮性】</li>
<li>所以 Eureka 在短时间内丢失过多客户端时就会自动进入保护模式，宁可保留错误的信息也不盲目注销任何可能健康的服务实例</li>
</ul>
<h4 id="如何关闭自我保护机制" class="headerLink">
    <a href="#%e5%a6%82%e4%bd%95%e5%85%b3%e9%97%ad%e8%87%aa%e6%88%91%e4%bf%9d%e6%8a%a4%e6%9c%ba%e5%88%b6" class="header-mark"></a>如何关闭自我保护机制</h4><ul>
<li>配置 Eureka Server 注册中心配置</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310201159168.png" alt="image-20230310201159168" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230310200445617.png" alt="image-20230310200445617" style="zoom:67%;" />
<ul>
<li>修改 eureka 客户端心跳间隔和直线上限时间</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230310200854213.png" alt="image-20230310200854213" style="zoom: 80%;" />
<h2 id="zookeeper-服务注册与发现" class="headerLink">
    <a href="#zookeeper-%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%8e%e5%8f%91%e7%8e%b0" class="header-mark"></a>Zookeeper 服务注册与发现</h2><ul>
<li>Zookeeper 是一个分布式协调工具，可以实现注册中心功能</li>
</ul>
<h3 id="临时节点-or-持久节点" class="headerLink">
    <a href="#%e4%b8%b4%e6%97%b6%e8%8a%82%e7%82%b9-or-%e6%8c%81%e4%b9%85%e8%8a%82%e7%82%b9" class="header-mark"></a>临时节点 or 持久节点</h3><ul>
<li>Zookeeper 也是有心跳机制，在一定时间内如果一直没心跳返回，Zookeeper就会把服务节点剔除掉</li>
<li>在 Eureka 中如果没有心跳了还会再保护模式中继续服务，所以在 Zookeeper 上的服务节点是 <strong>临时节点</strong></li>
</ul>
<h3 id="搭建-zookeeper-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-zookeeper-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Zookeeper 工程</h3><h4 id="创建-zookeeper-生产者步骤" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba-zookeeper-%e7%94%9f%e4%ba%a7%e8%80%85%e6%ad%a5%e9%aa%a4" class="header-mark"></a>创建 Zookeeper 生产者步骤</h4><ol>
<li>
<p>在虚拟机中使用 docker 搭建 Zookeeper 服务</p>
<ul>
<li>略</li>
</ul>
</li>
<li>
<p>创建生产者工程，添加 pom 依赖</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- Zookeeper --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>配置 yml 文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8004</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 服务别名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-provider-payment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 注册 Zookeeper 到注册中心名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">zookeeper</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">connect-string</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.30.129</span><span class="p">:</span><span class="m">2181</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>在主启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span> <span class="c1">// 该注解用于向使用 consul 或者 Zookeeper 作为注册中心时注册服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8004</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8004</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>进入 docker 中的 zookeeper 并查看当前服务
<ul>
<li>在有服务连接到 zookeeper 之后 <code>ls /</code> 即可看到 services 目录</li>
<li>services 目录中可以看到在生产者中配置好的微服务别名, 其中可以看到服务流水号</li>
<li>使用 <code>get</code> 命令获取某一服务中的某一注册相关信息 (JSON 格式)</li>
</ul>
</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230312145359755.png" alt="image-20230312145359755" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230312145633505.png" alt="image-20230312145633505" style="zoom:80%;" />
<h4 id="创建-zookeeper-消费者步骤" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba-zookeeper-%e6%b6%88%e8%b4%b9%e8%80%85%e6%ad%a5%e9%aa%a4" class="header-mark"></a>创建 Zookeeper 消费者步骤</h4><ol>
<li>添加上方同一个依赖</li>
<li>配置上方 yml 文件，注意修改 端口号 和 微服务别名</li>
<li>在主启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写配置类，注意添加 <code>@LoadBalanced</code> 为 RestTemplate 开启负载浚航，配置业务类</li>
<li>开启服务即可在 Zookeeper 服务中看到消费者别名</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230312153721640.png" alt="image-20230312153721640" style="zoom:80%;" />
<h4 id="zookeeper-注册中心集群" class="headerLink">
    <a href="#zookeeper-%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e9%9b%86%e7%be%a4" class="header-mark"></a>Zookeeper 注册中心集群</h4><ul>
<li>在不同的服务器中创建多个 Zookeeper 服务</li>
<li>在 yml 配置类中 <code>connect-string: IP:端口, IP:端口</code> 即可</li>
</ul>
<h4 id="遇到的问题依赖冲突" class="headerLink">
    <a href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98%e4%be%9d%e8%b5%96%e5%86%b2%e7%aa%81" class="header-mark"></a>遇到的问题：依赖冲突</h4><ul>
<li>由于服务器中 zookeeper 版本较低，而 SpringBoot 启动依赖中默认版本较高</li>
<li>在 POM 中排除自带的高版本 Zookeeper 依赖，自行引入对应版本的依赖即可</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--添加zookeeper3.4.9版本（引入对应版本的依赖）--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>3.4.9<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="consul-服务注册与发现" class="headerLink">
    <a href="#consul-%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%8e%e5%8f%91%e7%8e%b0" class="header-mark"></a>Consul 服务注册与发现</h2><ul>
<li>官网：https://www.consul.io/intro/index.html</li>
<li>是一套开源的，分布式服务发现 和 配置管理系统</li>
<li>由 HashiCorp 公司用 go 语言开发</li>
<li>主要特点
<ul>
<li><code>服务发现</code>：Consul 的客户端可以注册服务，例如 api 或 mysql，其他客户端可以使用 Consul 来发现给定服务的提供者。使用 DNS 或 HTTP，应用程序可以轻松找到它们依赖的服务</li>
<li><code>健康检测</code>：Consul 客户端可以提供任意数量的运行状况检查，这些检查可以与给定服务（“ Web服务器是否返回 200 OK”）或本地节点（“内存利用率低于90％”）相关。操作员可以使用此信息来监视群集的运行状况，服务发现组件可以使用此信息将流量从不正常的主机发送出去</li>
<li><code>K-V存储</code>：应用程序可以将 Consul 的分层 键/值 存储用于多种目的，包括动态配置，功能标记，协调，领导者选举等。简单的 HTTP API 使其易于使用</li>
<li><code>安全的服务通信</code>：Consul 可以为服务生成并分发 TLS 证书，以建立相互 TLS 连接。 意图可用于定义允许哪些服务进行通信。可以使用可以实时更改的意图轻松管理服务分段，而不必使用复杂的网络拓扑和静态防火墙规则</li>
<li><code>多数据中心</code>：Consul 开箱即用地支持多个数据中心。这意味着 Consul 的用户不必担心会构建其他抽象层以扩展到多个区域</li>
</ul>
</li>
</ul>
<h3 id="搭建-consul-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-consul-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Consul 工程</h3><ul>
<li>在虚拟机中使用 docker 搭建 consul 服务
<ul>
<li>成功后即可根据虚拟机 IP:8500 进入 consul 管理页面</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312162427360.png" alt="image-20230312162427360" style="zoom:80%;" />
<h4 id="创建-consul-生产者步骤" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba-consul-%e7%94%9f%e4%ba%a7%e8%80%85%e6%ad%a5%e9%aa%a4" class="header-mark"></a>创建 Consul 生产者步骤</h4><ol>
<li>创建生产者工程，配置 POM 文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="c">&lt;!-- consul --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-consul-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>编写 YML 配置文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8006</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 服务别名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-provider-payment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 注册 Consul</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">consul</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.30.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8500</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">service-name</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.application.name}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># 添加下方配置解决 Consul 红叉问题</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">heartbeat</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>在主启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在 Consul 的 UI 界面可以看到刚刚注册的生产者服务
<ul>
<li>此处可以看到服务列表，点进去看到其中有哪些服务实例</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312163725207.png" alt="image-20230312163725207" style="zoom:80%;" />
<h4 id="创建-consul-消费者步骤" class="headerLink">
    <a href="#%e5%88%9b%e5%bb%ba-consul-%e6%b6%88%e8%b4%b9%e8%80%85%e6%ad%a5%e9%aa%a4" class="header-mark"></a>创建 Consul 消费者步骤</h4><ol>
<li>添加上方同一个依赖</li>
<li>配置上方 yml 文件，注意修改 端口号 和 微服务别名</li>
<li>在主启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写配置类，注意添加 <code>@LoadBalanced</code> 为 RestTemplate 开启负载浚航，配置业务类</li>
<li>开启服务即可在 Consul UI 中看到消费者别名</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230312164557956.png" alt="image-20230312164557956" style="zoom:80%;" />
<h2 id="服务注册与发现-三者的异同" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c%e4%b8%8e%e5%8f%91%e7%8e%b0-%e4%b8%89%e8%80%85%e7%9a%84%e5%bc%82%e5%90%8c" class="header-mark"></a>服务注册与发现 三者的异同</h2><table>
<thead>
<tr>
<th>组件名</th>
<th>语言</th>
<th>CAP</th>
<th>服务健康检查</th>
<th>对外暴露接口</th>
<th>SpringCloud 集成</th>
</tr>
</thead>
<tbody>
<tr>
<td>Eureka</td>
<td>Java</td>
<td>AP</td>
<td>可配</td>
<td>HTTP</td>
<td>已集成</td>
</tr>
<tr>
<td>Zookeeper</td>
<td>Java</td>
<td>CP</td>
<td>支持</td>
<td>客户端</td>
<td>已集成</td>
</tr>
<tr>
<td>Consul</td>
<td>GO</td>
<td>CP</td>
<td>支持</td>
<td>HTPP / DNS</td>
<td>已集成</td>
</tr>
</tbody>
</table>
<h3 id="什么是-cap" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-cap" class="header-mark"></a>什么是 CAP</h3><ul>
<li>C**（Consistency）**：一致性</li>
<li>A**（Availability）**：可用性</li>
<li>P**（Partition tolerance）**：分区容错性（微服务架构必须保证有P）</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312165219001.png" alt="image-20230312165219001" style="zoom: 50%;" />
<ul>
<li>CAP 理论关注数据是粒度，而不是整体系统设计的策略</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312165345510.png" alt="image-20230312165345510" style="zoom: 67%;" />
<ul>
<li>Eureka 保证了 AP：
<ul>
<li>当网络分区出现后，为了保证可用性，系统 B 可以返回旧值，保证系统的可用性。</li>
<li>结论：违背了 一致性 C 的要求，只满足可用性和分区容错，即 AP</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/c9b28c547c954212b74002b16871ae07.png" alt="img" style="zoom:67%;" />
<ul>
<li>Consul 和 zookeeper 保证了 CP：
<ul>
<li>当网络分区出现后，为了保证一致性，就必须拒接请求，否则无法保证一致性</li>
<li>结论：违背了 可用性 A 的要求，只满足一致性和分区容错，即 CP</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/48b843ae23a643528be6302f73223fa1.png" alt="img" style="zoom:67%;" />
<h2 id="ribbon-负载均衡服务调用维护" class="headerLink">
    <a href="#ribbon-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e6%9c%8d%e5%8a%a1%e8%b0%83%e7%94%a8%e7%bb%b4%e6%8a%a4" class="header-mark"></a>Ribbon 负载均衡服务调用【维护】</h2><ul>
<li>Ribbon 是 Netflix 实现的一套客户端</li>
<li>提供客户端的软件 <strong>负载均衡</strong> 算法和 <strong>服务调用</strong>，提供完善的配置项（连接超时、重试）</li>
<li>Load Balancer（LB）的所有机器，Ribbon 会自动的根据负载均衡规则连接，并且可以很容易的自定义负载均衡算法</li>
</ul>
<blockquote>
<p>在 SpringBoot 提供的 Eureka Client 启动依赖中已经引入了 Ribbon</p>
</blockquote>
<h3 id="什么是负载均衡" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" class="header-mark"></a>什么是负载均衡</h3><ul>
<li>就是将用户的请求平摊到多个服务上，从而达到系统的 HA（高可用）</li>
<li>Nginx、LVS、硬件 F5 等</li>
</ul>
<h3 id="ribbon-与-nginx-的区别" class="headerLink">
    <a href="#ribbon-%e4%b8%8e-nginx-%e7%9a%84%e5%8c%ba%e5%88%ab" class="header-mark"></a>Ribbon 与 Nginx 的区别</h3><ul>
<li>Ribbon 是本地负载均衡客户端【进程内 LB】将注册中心的注册信息缓存到 JVM 中，从而在本地实现 RPC 远程服务调用</li>
<li>Nginx 是服务端负载均衡【集中式 LB】客户端的所有请求都会交给 Nginx 实现请求转发，属于是看大门的服务端</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312192743517.png" alt="image-20230312192743517" style="zoom: 67%;" />
<h3 id="ribbon-的工作流程" class="headerLink">
    <a href="#ribbon-%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" class="header-mark"></a>Ribbon 的工作流程</h3><ul>
<li>选择同一区域内负载较少的注册中心 Server</li>
<li>根据用户指定的策略，在 Server 取到的服务注册列表中选择一个地址</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312193459636.png" alt="image-20230312193459636" style="zoom:50%;" />
<h3 id="重温-resttemplate" class="headerLink">
    <a href="#%e9%87%8d%e6%b8%a9-resttemplate" class="header-mark"></a>重温 RestTemplate</h3><ul>
<li>官网：https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html</li>
</ul>
<p><img
        class="lazyload"
        data-src="SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203708993.png"
        data-srcset="SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203708993.png, SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203708993.png 1.5x, SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203708993.png 2x"
        data-sizes="auto"
        alt="SpringCloud自学笔记md版.assets/image-20230312203708993.png"
        title="image-20230312203708993"></p>
<p><img
        class="lazyload"
        data-src="SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203734905.png"
        data-srcset="SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203734905.png, SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203734905.png 1.5x, SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230312203734905.png 2x"
        data-sizes="auto"
        alt="SpringCloud自学笔记md版.assets/image-20230312203734905.png"
        title="image-20230312203734905"></p>
<ul>
<li><code>getForEntity()</code> 和 <code>getForObject()</code></li>
<li><code>postForEntity()</code> 和 <code>postForObject()</code></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678624571623-10.png" alt="img" style="zoom: 50%;" />
<h3 id="ribbon-提供的-irule-接口" class="headerLink">
    <a href="#ribbon-%e6%8f%90%e4%be%9b%e7%9a%84-irule-%e6%8e%a5%e5%8f%a3" class="header-mark"></a>Ribbon 提供的 IRule 接口</h3><ul>
<li>根据特定算法从服务列表中选取一个要访问的服务</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312210147052.png" alt="image-20230312210147052" style="zoom:80%;" />
<ul>
<li>IRule 自带的实现类：<em>默认为 RoundRobinRule 轮询</em></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312210412220.png" alt="image-20230312210412220" style="zoom: 80%;" />
<h3 id="更换-ribbon-负载均衡规则" class="headerLink">
    <a href="#%e6%9b%b4%e6%8d%a2-ribbon-%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e8%a7%84%e5%88%99" class="header-mark"></a>更换 Ribbon 负载均衡规则</h3><blockquote>
<ul>
<li>Ribbon 的自定义配置类不可以放在 @ComponentScan 所扫描的当前包下以及子包下，否则这个自定义配置类就会被所有的 Ribbon 客户端共享，达不到为指定的 Ribbon 定制配置</li>
<li>而 @SpringBootApplication 注解里就有 @ComponentScan 注解，所以不可以放在主启动类所在的包下。（因为 Ribbon 是客户端（消费者）这边的，所以 Ribbon 的自定义配置类是在客户端（消费者）添加，不需要在提供者或注册中心添加）</li>
</ul>
</blockquote>
<ol>
<li>在当前包外面新建 <code>com.atguigu.myrule</code> 包</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MySelfRule</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">IRule</span> <span class="nf">myRule</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">RandomRule</span><span class="o">();</span>    <span class="c1">//负载均衡机制改为随机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>为启动类添加注解
<ul>
<li>name 为指定的服务名（服务名必须与注册中心显示的服务名大小写一致）</li>
<li>configuration 为指定服务使用自定义配置（自定义负载均衡机制）</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RibbonClient</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">,</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">MySelfRule</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>重启此消费者工程，可以看到此时不再是轮询而是随机</li>
</ol>
<h3 id="ribbon-轮询负载均衡原理" class="headerLink">
    <a href="#ribbon-%e8%bd%ae%e8%af%a2%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%8e%9f%e7%90%86" class="header-mark"></a>Ribbon 轮询负载均衡原理</h3><ul>
<li>轮询算法：当前请求计数 % 集群总数 = N 号服务
<ul>
<li>1 % 2 = 1 号服务</li>
<li>2 % 2 = 0 号服务</li>
<li>3 % 2 = 1 号服务</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312204531138.png" alt="image-20230312204531138" style="zoom:80%;" />
<ul>
<li>由 RoundRobin 实现的 IRule 接口中 choose 方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">Server</span> <span class="nf">choose</span><span class="o">(</span><span class="n">ILoadBalancer</span> <span class="n">lb</span><span class="o">,</span> <span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 判断负载均衡算法是否为 NULL 如果为 NULL 则返回空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">(</span><span class="n">lb</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;no load balancer&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="o">(</span><span class="n">server</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">)</span> <span class="o">{</span><span class="err">、</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取可达的服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span> <span class="n">reachableServers</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="na">getReachableServers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获得所有的服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Server</span><span class="o">&gt;</span> <span class="n">allServers</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="na">getAllServers</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 获取可达的服务数量、所有的服务数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">upCount</span> <span class="o">=</span> <span class="n">reachableServers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">serverCount</span> <span class="o">=</span> <span class="n">allServers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="c1">// 判断可达的和所有的服务数量是否为 0, 如果为 0 则返回空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">((</span><span class="n">upCount</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">serverCount</span> <span class="o">==</span> <span class="n">0</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;No up servers available from load balancer: &#34;</span> <span class="o">+</span> <span class="n">lb</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 获取到当前轮到的服务下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">nextServerIndex</span> <span class="o">=</span> <span class="n">incrementAndGetModulo</span><span class="o">(</span><span class="n">serverCount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 获取该下标的服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">server</span> <span class="o">=</span> <span class="n">allServers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">nextServerIndex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// 如果服务为 NULL 则返回空
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">server</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Transient. */</span>
</span></span><span class="line"><span class="cl">            <span class="n">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">server</span><span class="o">.</span><span class="na">isAlive</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">server</span><span class="o">.</span><span class="na">isReadyToServe</span><span class="o">()))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">(</span><span class="n">server</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Next.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">server</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">10</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;No available alive servers after 10 tries from load balancer: &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">+</span> <span class="n">lb</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">server</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>通过 CAS 自旋锁（比较并交换）如果当前值的内存地址和期望值相同则交换并返回 true 否则在此自旋</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312222240270.png" alt="image-20230312222240270" style="zoom:80%;" />
<ul>
<li>比较并交换:
<ul>
<li>将期望值 expect 与传入对象 this 在内存中的偏移量为 valueoffset 的值（旧值）作比较, 如果相等, 就把 update （新值）赋值给 valueoffset , 返回 true</li>
<li>具体的操作是由类 sun.misc.Unsafe 来负责的，Unsafe 类提供了硬件级别的原子操作，使用 native 方法来间接访问操作系统底层（如系统硬件等)</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230312222916393.png" alt="image-20230312222916393" style="zoom:80%;" />
<h3 id="手写轮询算法" class="headerLink">
    <a href="#%e6%89%8b%e5%86%99%e8%bd%ae%e8%af%a2%e7%ae%97%e6%b3%95" class="header-mark"></a>手写轮询算法</h3><ol>
<li>去除 <code>@LoadBalanced</code> 注解</li>
<li>新建 lb 包，创建 ILoadBalancer 接口（面向接口编程）</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ILoadBalancer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//传入具体实例的集合，返回选中的实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ServiceInstance</span> <span class="nf">instances</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">serviceInstance</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>创建实现类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>  <span class="c1">// 加入容器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyLB</span> <span class="kd">implements</span> <span class="n">ILoadBalancer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 新建一个原子整形类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取当前访问计数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">current</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 如果 current 是最大值，重新计算，否则加 1（防止越界）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">next</span> <span class="o">=</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">current</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// 进行 CAS 判断，如果不为 true，进行自旋
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">current</span><span class="o">,</span> <span class="n">next</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;****第几次访问，次数next：&#34;</span> <span class="o">+</span> <span class="n">next</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">ServiceInstance</span> <span class="nf">instances</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">serviceInstance</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 非空判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">serviceInstance</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 进行取余
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">getAndIncrement</span><span class="o">()</span> <span class="o">%</span> <span class="n">serviceInstance</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 返回选中的服务实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">serviceInstance</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>在 Controller 中添加方法，使用自己轮询算法获取到的服务实例 URI 进行访问</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="c1">// 注入自己写的负载均衡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ILoadBalancer</span> <span class="n">iLoadBalancer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 注入获取所有服务实例列表所需的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DiscoveryClient</span> <span class="n">discoveryClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/lb&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPaymentLB</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取 CLOUD-PAYMENT-SERVICE 服务的所有具体实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getInstances</span><span class="o">(</span><span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">instances</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">instances</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 调用自己写的负载均衡轮询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ServiceInstance</span> <span class="n">serviceInstance</span> <span class="o">=</span> <span class="n">iLoadBalancer</span><span class="o">.</span><span class="na">instances</span><span class="o">(</span><span class="n">instances</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取到当前轮到的 URI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">serviceInstance</span><span class="o">.</span><span class="na">getUri</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用轮询到的 URI 进行访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">uri</span> <span class="o">+</span> <span class="s">&#34;/payment/lb&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230313152639002.png" alt="image-20230313152639002" style="zoom:80%;" />
<h2 id="openfeign-服务接口调用" class="headerLink">
    <a href="#openfeign-%e6%9c%8d%e5%8a%a1%e6%8e%a5%e5%8f%a3%e8%b0%83%e7%94%a8" class="header-mark"></a>OpenFeign 服务接口调用</h2><ul>
<li>Feign 是一个声明式的 web 服务客户端，让编写 web 服务客户端变得非常容易，只需创建一个接口并在接口上添加注解即可</li>
<li>支持可拔插式的编码器和解码器，就是在参考 Ribbon 的基础上做的一套服务接口加注解方式调用的整合</li>
<li>Feign 已经过时，OpenFeign 替代了它。官网：https://github.com/spring-cloud/spring-cloud-openfeign</li>
</ul>
<h3 id="什么是-feignopenfeign" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-feignopenfeign" class="header-mark"></a>什么是 Feign、OpenFeign</h3><ul>
<li>Feign 旨让编写 Java HTTP 客户端更容易</li>
<li>在实际开发中，对于服务以来的调用可能远远不止一处，一个接口可能会被多处调用，所以通常需要对每个微服务进行封装一些客户端类来包装这些调用</li>
<li>使用 Feign 只需创建一个<strong>接口</strong>并使用注解的方式来配置它即可，完成服务提供方的接口绑定</li>
<li>Feign 集成了 Ribbon（维护服务列表信息再通过轮询实现客户端负载均衡）Feign 只需要定义服务绑定接口并以声明式的方法，优雅而简单的实现了服务调用</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678698953675-13.png" alt="在这里插入图片描述" style="zoom: 50%;" />
<h3 id="搭建-openfeign-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-openfeign-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 OpenFeign 工程</h3><ol>
<li>创建消费者工程，添加 POM 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- openfeign --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在启动类上添加注解，激活并开启 Feign</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span> <span class="c1">// 激活 Feign
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderFeignMain80</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderFeignMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>在 service 包中创建 FeignService 接口并添加注解指定生产者微服务别名 <a id='OpenFeignService'> </a></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentFeignService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>在控制层中注入 Feign 接口，调用其中方法就是调用生产者</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderFeignController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PaymentFeignService</span> <span class="n">paymentFeignService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/get/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">paymentFeignService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>在启动类上标注激活 Feign 的注解 <code>@EnableFeignClients</code></li>
<li>创建 FeignClient 的接口（这里是 PaymentFeignService）标注 <code>@FeignClient()</code> 注解并指定生产者服务别名</li>
<li>在这个接口中定义的方法要和生产者中的方法一样（复制过来，包括注解），在业务层中即可注入这个接口调用其方法（也就是调用生产者）</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230313180341322.png" alt="image-20230313180341322" style="zoom:80%;" />
<h3 id="feign-的超时控制" class="headerLink">
    <a href="#feign-%e7%9a%84%e8%b6%85%e6%97%b6%e6%8e%a7%e5%88%b6" class="header-mark"></a>Feign 的超时控制</h3><ul>
<li>消费者的超时报错：生产者一个业务需要用 3 秒种才能处理完成，但是消费者只愿意等 1 秒钟，1 秒之后就报错</li>
<li>默认的超时策略遇到这种长流程调用、复杂业务就会出现报错（消费者默认等待 1 秒钟）此时我们需要配置 Feign 的超时策略</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 没提示不管它，可以设置 (或使用 feign.client.config.default.ConnectTimeOut)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 指的是建立连接后从服务器读取到可用资源所用的时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ReadTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 指的是建立连接使用的时间，适用于网络状况正常的情况下，两端连接所用的时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ConnectTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="feign-的日志增强" class="headerLink">
    <a href="#feign-%e7%9a%84%e6%97%a5%e5%bf%97%e5%a2%9e%e5%bc%ba" class="header-mark"></a>Feign 的日志增强</h3><ul>
<li>通过调整日志级别来对 Feign 接口调用情况进行监控和输出</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678716959846-20.png" alt="在这里插入图片描述" style="zoom: 43%;" />
<ol>
<li>在消费者 config.FeignConfig 类中进行配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">feign.Logger</span><span class="o">;</span> <span class="c1">// 不要导错包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeignConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="n">Logger</span><span class="o">.</span><span class="na">Level</span> <span class="nf">feignLoggerLevel</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//打印最详细的日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">Logger</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">FULL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在 YML 中添加配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c">#开启日志的 feign 客户端</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># feign 日志以什么级别监控哪个接口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">com.atguigu.springcloud.service.PaymentFeignService</span><span class="p">:</span><span class="w"> </span><span class="l">debug	# 写到 Feign 的服务接口</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="hystrix-断路器维护" class="headerLink">
    <a href="#hystrix-%e6%96%ad%e8%b7%af%e5%99%a8%e7%bb%b4%e6%8a%a4" class="header-mark"></a>Hystrix 断路器【维护】</h2><h3 id="服务降级-解决什么问题" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7-%e8%a7%a3%e5%86%b3%e4%bb%80%e4%b9%88%e9%97%ae%e9%a2%98" class="header-mark"></a>服务降级 解决什么问题</h3><ul>
<li>在复杂的分布式体系结构中的应用程序有数十个依赖服务，每个依赖关系都不可避免出现失败</li>
<li>服务雪崩
<ul>
<li>一个微服务调用 N 个微服务，这 N 个微服务又会调用 M 个微服务&hellip; 【<strong>扇出</strong>】</li>
<li>如果扇出链路上某个微服务调用时间过长或不可用，对第一个服务的调用就会占用越来越多的系统资源</li>
<li>为了解决这种雪崩（<strong>级联故障</strong>）问题，提出服务降级的概念（链路中断的解决方案）</li>
</ul>
</li>
</ul>
<h3 id="什么是-hystrix" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-hystrix" class="header-mark"></a>什么是 Hystrix</h3><ul>
<li>
<p>是一种用于处理分布式的 <strong>延迟</strong>、<strong>容错</strong> 的开源库，保证在一个依赖出错的情况下，避免级联故障，以提高分布式系统的弹性</p>
</li>
<li>
<p><code>断路器</code> 当监控到某个服务故障后，向调用方法返回一个符合预期的、可处理的备选方案（FallBack），而不是长时间等待或异常</p>
</li>
<li>
<p><strong>保证服务调用方的线程不会被长时间占用</strong>，从而避免了故障在分布式系统中的蔓延，乃至雪崩</p>
</li>
<li>
<p>官网：https://github.com/Netflix/Hystrix/wiki/How-To-Use</p>
</li>
</ul>
<h3 id="服务降级-相关概念" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7-%e7%9b%b8%e5%85%b3%e6%a6%82%e5%bf%b5" class="header-mark"></a>服务降级 相关概念</h3><ul>
<li>
<p>服务降级（fallback）</p>
<ul>
<li>在服务出现问题的时候，提供一个备选处理方案（友好提示）</li>
<li>触发降级：运行异常、服务超时、服务熔断、线程池 / 信号量 满</li>
</ul>
<blockquote>
<p>提供者和消费者都可以进行服务降级。（一般都是放在客户端（消费者））</p>
</blockquote>
</li>
<li>
<p>服务熔断（break）</p>
<ul>
<li>相当于保险丝达到最大访问量后，拒绝访问，跳闸停电</li>
<li>调用服务降级的方案返回友好提示</li>
</ul>
</li>
<li>
<p>服务限流（flowlimit）</p>
<ul>
<li>当出现高并发情况，一窝蜂的拥挤，此时服务限流让大家排队，每秒处理 N 个，有序进行</li>
</ul>
</li>
</ul>
<h3 id="搭建-hystrix-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-hystrix-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Hystrix 工程</h3><ol>
<li>创建生产者工程，配置 POM 文件添加 Hystrix 启动依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- hystrix--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>编写 YML 配置文件，服务端口、微服务名、注册中心</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-provider-hystrix-payment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># 单机版</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写启动类，开启 Eureka 配置中心</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentHystrixMain8001</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentHystrixMain8001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="高并发测试" class="headerLink">
    <a href="#%e9%ab%98%e5%b9%b6%e5%8f%91%e6%b5%8b%e8%af%95" class="header-mark"></a>高并发测试</h4><ul>
<li>这里配置两个接口，一个正常接口立即返回内容，一个超时接口等待三秒再返回</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315144554760.png" alt="image-20230315144554760" style="zoom: 67%;" />
<ul>
<li>这时使用 JMeter 进行压力测试，开启线程组每秒 200 个线程，循环 100 次，向 超时接口 发送 HTTP 请求</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315144627951.png" alt="image-20230315144627951" style="zoom:67%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230315144643658.png" alt="image-20230315144643658" style="zoom:67%;" />
<ul>
<li>
<p>此时发现问题：超时接口转圈卡顿，正常接口也发生转圈卡顿</p>
</li>
<li>
<p><strong>Tomcat 线程池里面的工作线程已经被挤占完毕</strong>，没有多余的线程来分解压力和处理。</p>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315151445548.png" alt="image-20230315151445548" style="zoom: 67%;" />
<ul>
<li>如果此时再加上消费者请求，还有可能造成 <strong>消费端报超时错误</strong></li>
</ul>
<h3 id="服务降级-的情况" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7-%e7%9a%84%e6%83%85%e5%86%b5" class="header-mark"></a>服务降级 的情况</h3><ul>
<li>服务<strong>提供者超时</strong>了，消费者不能一直卡死等待，此时需要服务降级</li>
<li>服务<strong>提供者宕机</strong>了，消费者不能一直卡死等待，此时需要服务降级</li>
<li>服务<strong>提供者没问题</strong>，<strong>消费者自己出故障、等待时间超了</strong>，此时自己处理降级</li>
</ul>
<h3 id="在生产者端-服务降级配置" class="headerLink">
    <a href="#%e5%9c%a8%e7%94%9f%e4%ba%a7%e8%80%85%e7%ab%af-%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7%e9%85%8d%e7%bd%ae" class="header-mark"></a>在生产者端 服务降级配置</h3><ol>
<li>为容易发生超时的方法上添加注解，指定超时的条件，超时的回调方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s">&#34;paymentInfo_TimeOutHandler&#34;</span><span class="o">,</span> <span class="n">commandProperties</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 设置自身超时调用时间的峰值为 3 秒，峰值内可以正常运行，超过了需要有兜底的方法处理，服务降级 fallback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nd">@HystrixProperty</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;execution.isolation.thread.timeoutInMilliseconds&#34;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;3000&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">})</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_TimeOut</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">timeNumber</span> <span class="o">=</span> <span class="n">5</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">timeNumber</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;线程池：&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;\tpaymentInfo_TimeOut，id：&#34;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&#34;，耗时：&#34;</span> <span class="o">+</span> <span class="n">timeNumber</span> <span class="o">+</span> <span class="s">&#34;秒&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_TimeOutHandler</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;线程池：&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\tpaymentInfo_TimeOutHandler，id：&#34;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在启动类上添加注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableCircuitBreaker</span> <span class="c1">// 启用断路器
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此时调用接口访问此方法，在满足超时条件时，会自动调用其对应的 fallback 方法【<strong>可以看到此处用的是 Hystrix 的线程池中的线程</strong>】</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315153754784.png" alt="image-20230315153754784" style="zoom:80%;" />
<ul>
<li>如果是运行时异常，也会自动调用其对应的 fallback 方法</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315154305954.png" alt="image-20230315154305954" style="zoom: 67%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230315154236102.png" alt="image-20230315154236102" style="zoom:80%;" />
<blockquote>
<p>SpringBoot 的热部署插件对 @HystrixCommand 内属性的修改不灵，建议手动重启</p>
</blockquote>
<h3 id="在消费者端-服务降级配置" class="headerLink">
    <a href="#%e5%9c%a8%e6%b6%88%e8%b4%b9%e8%80%85%e7%ab%af-%e6%9c%8d%e5%8a%a1%e9%99%8d%e7%ba%a7%e9%85%8d%e7%bd%ae" class="header-mark"></a>在消费者端 服务降级配置</h3><ol>
<li>在消费者的 YML 配置文件中添加，开启 Feign 对 Hystrix 断路器的支持</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在启动类上添加注解开启 Hystrix 的支持</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableHystrix</span> <span class="c1">// 其中包含了 @EnableCircuitBreaker
</span></span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230315155245804.png" alt="image-20230315155245804" style="zoom:80%;" />
<ol start="3">
<li>和生产者一样配置断路的处理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s">&#34;paymentTimeOutFallbackMethod&#34;</span><span class="o">,</span> <span class="n">commandProperties</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@HystrixProperty</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;execution.isolation.thread.timeoutInMilliseconds&#34;</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#34;1500&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/hystrix/timeout/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_TimeOut</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentHystrixService</span><span class="o">.</span><span class="na">paymentInfo_TimeOut</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentTimeOutFallbackMethod</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;消费者80，支付系统繁忙&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>测试发现：
<ul>
<li>如果是由于生产者的超时造成的服务降级，则优先进入 消费者 fallback</li>
<li>如果是由于生产者的异常造成的服务降级，则优先进入 生产者 fallback</li>
<li>如果是由于消费者等不及造成的服务降级，则优先进入 消费者 fallback</li>
</ul>
</li>
</ul>
<h3 id="遇到的问题-a-idhystrixproblem-a" class="headerLink">
    <a href="#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98-a-idhystrixproblem-a" class="header-mark"></a>遇到的问题 <a id='HystrixProblem'> </a></h3><ul>
<li>
<p>每个业务方法都要配置一个兜底方法，导致代码膨胀</p>
<ul>
<li>
<p>除了个别业务有专属 fallback，其它普通业务可以配置全局统一兜底方法：为类添加注解并设置统一兜底方法，在业务方法上添加注解</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@DefaultProperties</span><span class="o">(</span><span class="n">defaultFallback</span> <span class="o">=</span> <span class="s">&#34;payment_Global_FallbackMethod&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderHystrixController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">PaymentHystrixService</span> <span class="n">paymentHystrixService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@HystrixCommand</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/hystrix/ok/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_OK</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentHystrixService</span><span class="o">.</span><span class="na">paymentInfo_OK</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ...... 如果有需要独享兜底方法的业务方法也可以根据上方专属 fallback 配置来处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 全局业务处理兜底 fallback 方法
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return 提示
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">payment_Global_FallbackMethod</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;消费者80，支付系统繁忙, 进入全局兜底方法&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>兜底方法和业务逻辑混在一起，导致代码混乱，耦合度高</p>
<ol>
<li>为 FeignClient 接口创建实现类，在实现类中重写所有接口方法，就是兜底方法</li>
</ol>
  <img src="SpringCloud自学笔记md版.assets/image-20230315163926484.png" alt="image-20230315163926484" style="zoom: 80%;" />
<ol start="2">
<li>为接口 <code>@FeignClient</code> 注解添加 fallback 属性指定到这个实现类上 <a id='FeignClientFallback'> </a></li>
</ol>
  <img src="SpringCloud自学笔记md版.assets/image-20230315164020216.png" alt="image-20230315164020216" style="zoom:80%;" />
<ul>
<li>此时当所有生产者服务都宕机无法做出回应时，就会自动调用这里的兜底方法</li>
<li>但是生产者还是可用状态只是无法在消费者接受的时间内响应的话，会调用消费者的全局兜底方法（有配置独享兜底方法除外）</li>
<li>当生产者发生不是配置的超时问题时（运行时异常）则会调用生产者的兜底方法</li>
</ul>
</li>
<li>
<p>此时服务端 provider 已经 down 了，但是我们做了服务降级处理，<strong>让客户端在服务端不可用时也会获得提示信息而不会挂起耗死服务器</strong></p>
</li>
</ul>
<h3 id="服务熔断-的情况" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e7%86%94%e6%96%ad-%e7%9a%84%e6%83%85%e5%86%b5" class="header-mark"></a>服务熔断 的情况</h3><ul>
<li>服务调用失败会触发降级，降级会调用其 fallback 方法，无论如何降级的流程是先调用正常方法后调用 fallback 方法</li>
<li>服务熔断是指单位时间内失败的次数过多，也就是降级次数过多，则触发熔断 <strong>跳过正常方法直接调用 fallback 方法</strong></li>
<li><code>熔断后不可用</code> 就像是保险丝跳闸了，需要检测到节点调用响应正常后，恢复调用链路</li>
</ul>
<h3 id="在生产者端-服务熔断配置" class="headerLink">
    <a href="#%e5%9c%a8%e7%94%9f%e4%ba%a7%e8%80%85%e7%ab%af-%e6%9c%8d%e5%8a%a1%e7%86%94%e6%96%ad%e9%85%8d%e7%bd%ae" class="header-mark"></a>在生产者端 服务熔断配置</h3><ul>
<li>在生产者 Service 中配置 <code>@HystrixCommand</code> 注解中配置开启断路器，设置在 10 秒时间内，总阈值为 10 次，如果错误率达到 60%（也就是 6 次），跳闸</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315171759083.png" alt="image-20230315171759083" style="zoom:80%;" />
<ul>
<li>添加对应控制层方法进行访问
<ul>
<li>在 10 秒内进行多次错误尝试，触发断路器服务熔断，此时如果再进行正确的访问依然进入 fallback 方法，10 秒后开启半开模式，直到正确的处理请求</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230315172744234.png" alt="image-20230315172744234" style="zoom:80%;" />
<h3 id="服务限流-的情况" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e9%99%90%e6%b5%81-%e7%9a%84%e6%83%85%e5%86%b5" class="header-mark"></a>服务限流 的情况</h3><ul>
<li>后面会在 SpringCloud  Alibaba 中的 Sentinel 说明</li>
</ul>
<h3 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h3><blockquote>
<p>如果请求次数的错误率超过指定值，开启熔断，经过一段时间后，变为半开模式然后放进一个请求进行处理，如果请求处理成功，关闭熔断；如果还是报错，继续进入熔断，再经过一段时间后，变为半开模式，再进行对下一个请求进行处理，一直在熔断，半开模式来回切换，直到请求成功，关闭熔断。</p>
</blockquote>
<img src="SpringCloud自学笔记md版.assets/state.png" alt="img" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230316140736003.png" alt="image-20230316140736003" style="zoom:80%;" />
<ul>
<li>
<p>断路器在什么时候开始起作用</p>
  <img src="SpringCloud自学笔记md版.assets/image-20230316141056723.png" alt="image-20230316141056723" style="zoom:80%;" />
<ul>
<li>快照时间窗：断路器确定是否打开 需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的 10 秒</li>
<li>请求总数阈值：在快照时间窗内，必须满足请求总数阈值才有资格熔断。默认 20，意味着在 10 秒内，如果调用次数不足 20 次，即使所有的请求都超时或失败，断路器也不会打开</li>
<li>错误百分比阈值：当请求总数在快照时间窗内超过了阈值，比如发生了 30 次调用，如果在这 30 次调用中，有 15 次发生了超时异常，也就是通过了 50% 的错误百分比（默认）这时候就会将断路器打开</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述" style="zoom: 43%;" />
<img src="SpringCloud自学笔记md版.assets/hystrix-command-flow-chart.png" alt="img" style="zoom:80%;" />
<h3 id="hystrix-的-dashboard-仪表盘" class="headerLink">
    <a href="#hystrix-%e7%9a%84-dashboard-%e4%bb%aa%e8%a1%a8%e7%9b%98" class="header-mark"></a>Hystrix 的 dashboard 仪表盘</h3><ul>
<li>如何搭建按照官网 WIKI：<a href="https://github.com/Netflix-Skunkworks/hystrix-dashboard/wiki" target="_blank" rel="noopener noreffer">Home · Netflix-Skunkworks/hystrix-dashboard Wiki (github.com)</a></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678948494380-7.png" alt="在这里插入图片描述" style="zoom: 25%;" />
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678948510387-10.png" alt="在这里插入图片描述" style="zoom: 45%;" />
<h2 id="zuul-服务网关" class="headerLink">
    <a href="#zuul-%e6%9c%8d%e5%8a%a1%e7%bd%91%e5%85%b3" class="header-mark"></a>Zuul 服务网关</h2><ul>
<li>zuul 核心人员被挖走了三个、内部分歧，zuul2 的研发过久，spring  公司等不及，自己研发的 Gateway 网关</li>
<li>Zuul 的官网 WIKI：<a href="https://github.com/Netflix/zuul/wiki" target="_blank" rel="noopener noreffer">Home · Netflix/zuul Wiki (github.com)</a></li>
</ul>
<blockquote>
<p>Zuul 1.x 是一个基于 Servlet 2.5 <strong>阻塞 I/O</strong> 的 API Gateway，每次 I/O 操作都是从工作线程中选择一个执行，请求线程被阻塞到工作完成完成</p>
<p>Zuul 1.x 的设计模式和 Nginx 有点像，但是 Nginx 是用 C/C++ 实现的，Zuul 是用 Java 实现具有 JVM 首次加载较慢的特性，性能相对较差</p>
<p>Zuul 2.x 是基于 Netty 非阻塞和支持长连接。SpringCloud 的 Gateway 是 Zuul 的 1.6 倍</p>
</blockquote>
<h3 id="什么是服务网关" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e6%9c%8d%e5%8a%a1%e7%bd%91%e5%85%b3" class="header-mark"></a>什么是服务网关</h3><ul>
<li>统一的挡在前面进行日志、限流、权鉴、安全加固等</li>
</ul>
<h2 id="gateway-服务网关" class="headerLink">
    <a href="#gateway-%e6%9c%8d%e5%8a%a1%e7%bd%91%e5%85%b3" class="header-mark"></a>Gateway 服务网关</h2><ul>
<li>
<p>Gateway 提供一种简单有效的方式来对 API 进行路由</p>
</li>
<li>
<p>基于 Filter 链的方式提供网关的基本功能：安全、监控/指标、限流</p>
</li>
<li>
<p>为了提升性能 Gateway 是基于 WebFlux 框架实现的</p>
</li>
</ul>
<blockquote>
<p>WebFlux 框架是 Spring5 提供的一种底层使用了高性能的 Reactor 模式通信框架 Netty，在高并发和非阻塞式通信场景下非常有优势</p>
<blockquote>
<p>阻塞式 I/O 模型中，例如 Servlet，当请求进入 servlet container 时，servlet container 就会为其绑定一个线程, 在并发不高的场景下这种模型是适用的。但是一旦高并发 (比如用 jemeter 压测) ，线程数量就会上涨，而线程资源代价是昂贵的 (上线文切换，内存消耗大) 严重影响请求的处理时间。在一些简单业务场景下, 不希望为每个 request 分配一个线程， 只需要 1 个或几个线程就能应对极大并发的请求，这种业务场景下 servlet 模型没有优势。</p>
<p>所以 Zuul 1.X 是基于 Servlet 之上的一个阻塞式处理模型, 即 spring 实现了处理所有 request 请求的一个 servlet (DispatcherServlet) 并由该 servlet 阻塞式处理处理。所以Springcloud Zuul无法摆脱 servlet 模型的弊端</p>
</blockquote>
</blockquote>
<h3 id="gateway-的特性" class="headerLink">
    <a href="#gateway-%e7%9a%84%e7%89%b9%e6%80%a7" class="header-mark"></a>Gateway 的特性</h3><ol>
<li>动态路由（Route）：能够匹配任何请求属性</li>
<li>集成服务发现功能、Hystrix 的断路器功能</li>
<li>拥有易于编写的 断言（Predicate）和过滤器（Filter）</li>
<li>请求限流功能、支持路径重写</li>
</ol>
<h3 id="gateway-的核心概念" class="headerLink">
    <a href="#gateway-%e7%9a%84%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5" class="header-mark"></a>Gateway 的核心概念</h3><ul>
<li>路由（Route）
<ul>
<li>路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由</li>
</ul>
</li>
<li>断言（Predicate）
<ul>
<li>参考的是 java8 的 java.util.function.Predicate</li>
<li>开发人员可以匹配 HTTP 请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由</li>
</ul>
</li>
<li>过滤（Filter）
<ul>
<li>指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</li>
</ul>
</li>
</ul>
<h3 id="gateway-工作流程" class="headerLink">
    <a href="#gateway-%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" class="header-mark"></a>Gateway 工作流程</h3><ul>
<li>客户端向 Gateway 发出请求，然后在 Gateway handler Mapping 中<strong>找到与请求相匹配的路由</strong>【路由转发】</li>
<li>将其发送到 Gateway Web Handler 通过指定的<strong>过滤链</strong>来将请求发送到<strong>实际的服务执行业务</strong>逻辑【执行过滤链】
<ul>
<li>在发送代理请求之前（pre）可以做参数校验、权限校验、流量监控、日志输出、协议转换等</li>
<li>在处理完请求之后（post）可以做相应内容、响应头的修改、日志的输出、流量监控等</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/spring_cloud_gateway_diagram.png" alt="Spring Cloud Gateway Diagram" style="zoom:80%;" />
<h3 id="搭建-gateway-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-gateway-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Gateway 工程</h3><ol>
<li>添加 POM 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">	<span class="c">&lt;!-- gateway --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="c">&lt;!-- eureka client(通过微服务名实现动态路由) --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="c">&lt;!-- 一般通用依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="c">&lt;!-- 此处不需要 spring-boot-starter-web 依赖，因为是网关，用的是 Webflux --&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>配置 YML 文件
<ul>
<li>在配置了网关路由之后，想访问断言中的路径的话就会先经由此项目过滤</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9527</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 下方配置 Gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">payment_route</span><span class="w"> </span><span class="c"># 路由的id, 没有规定规则但要求唯一, 建议配合服务名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8001</span><span class="w"> </span><span class="c"># 匹配后提供服务的路由地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">Path=/payment/get/**</span><span class="w"> </span><span class="c"># 断言, 路径相匹配的进行路由</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">payment_route2</span><span class="w"> </span><span class="c"># 路由的id, 没有规定规则但要求唯一, 建议配合服务名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:8001</span><span class="w"> </span><span class="c"># 匹配后提供服务的路由地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">Path=/payment/lb/**</span><span class="w"> </span><span class="c"># 断言, 路径相匹配的进行路由</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-gateway-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka/</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayMain9527</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">GatewayMain9527</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>测试，此时通过 <code>http://localhost:8001/payment/get/1</code> 也可以访问</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230316181810946.png" alt="image-20230316181810946" style="zoom:80%;" />
<h4 id="第二种配置方式" class="headerLink">
    <a href="#%e7%ac%ac%e4%ba%8c%e7%a7%8d%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f" class="header-mark"></a>第二种配置方式</h4><ul>
<li>使用注入 RouteLocator 的 Bean 的方式配置</li>
</ul>
<ol>
<li>新建配置类 config.GatewayConfig</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">RouteLocator</span> <span class="nf">customRouteLocator</span><span class="o">(</span><span class="n">RouteLocatorBuilder</span> <span class="n">routeLocatorBuilder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">RouteLocatorBuilder</span><span class="o">.</span><span class="na">Builder</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">routeLocatorBuilder</span><span class="o">.</span><span class="na">routes</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">routes</span><span class="o">.</span><span class="na">route</span><span class="o">(</span><span class="s">&#34;path_route_auguigu&#34;</span><span class="o">,</span>  <span class="c1">// id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&#34;/guonei&#34;</span><span class="o">)</span>  <span class="c1">// 访问 http://localhost:9527/guonei
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;https://news.baidu.com/&#34;</span><span class="o">));</span>  <span class="c1">// 就会转发到 https://news.baidu.com
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">routes</span><span class="o">.</span><span class="na">route</span><span class="o">(</span><span class="s">&#34;path_route_atguigu2&#34;</span><span class="o">,</span>  <span class="c1">// id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&#34;/guoji&#34;</span><span class="o">)</span>  <span class="c1">// 访问 http://localhost:9527/guoji
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;https://news.baidu.com/&#34;</span><span class="o">));</span>  <span class="c1">// 就会转发到 https://news.baidu.com
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">routes</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//    @Bean
</span></span></span><span class="line"><span class="cl"><span class="c1">//    public RouteLocator customRouteLocator2(RouteLocatorBuilder routeLocatorBuilder){
</span></span></span><span class="line"><span class="cl"><span class="c1">//        RouteLocatorBuilder.Builder routes = routeLocatorBuilder.routes();
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//        routes.route(&#34;path_route_atguigu2&#34;,  //id
</span></span></span><span class="line"><span class="cl"><span class="c1">//                r -&gt; r.path(&#34;/guoji&#34;)  //访问 http://localhost:9527/guoji
</span></span></span><span class="line"><span class="cl"><span class="c1">//                        .uri(&#34;https://news.baidu.com/&#34;));  //就会转发到 https://news.baidu.com
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//        return routes.build();
</span></span></span><span class="line"><span class="cl"><span class="c1">//    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="实现动态路由" class="headerLink">
    <a href="#%e5%ae%9e%e7%8e%b0%e5%8a%a8%e6%80%81%e8%b7%af%e7%94%b1" class="header-mark"></a>实现动态路由</h4><ul>
<li>当前情况下路由地址是写死的，但是生产者往往都是集群，所以需要配置到生产者微服务别名，进行动态路由转发</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230316184502331.png" alt="image-20230316184502331" style="zoom:80%;" />
<ol>
<li>修改配置文件，开启动态路由功能，并修改提供服务的路由地址为生产者微服务别名</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230316185241140.png" alt="image-20230316185241140" style="zoom:80%;" />
<h3 id="断言-predicate-的使用" class="headerLink">
    <a href="#%e6%96%ad%e8%a8%80-predicate-%e7%9a%84%e4%bd%bf%e7%94%a8" class="header-mark"></a>断言 Predicate 的使用</h3><ul>
<li>在项目启动时可以看到由断言工厂加载了很多 Predicate</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230316185746961.png" alt="image-20230316185746961" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1678964518874-15.png" alt="在这里插入图片描述" style="zoom: 43%;" />
<ul>
<li>可以查看官网：<a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories" target="_blank" rel="noopener noreffer">Spring Cloud Gateway</a> 关于这部分的介绍</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230316195654237.png" alt="image-20230316195654237" style="zoom:80%;" />
<ul>
<li>在原有 predicates 下方添加新的断言规则即可（这里 after 表示）</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230316192022785.png" alt="image-20230316192022785" style="zoom:80%;" />
<ul>
<li>在添加了 cookie 断言时，使用 curl 命令测试</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230316192717118.png" alt="image-20230316192717118" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230316192637436.png" alt="image-20230316192637436" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230316194359659.png" alt="image-20230316194359659" style="zoom:80%;" />
<ul>
<li>在添加了 Header 断言时，使用 curl 命令测试</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230316194306556.png" alt="image-20230316194306556" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230316194317951.png" alt="image-20230316194317951" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230316194340173.png" alt="image-20230316194340173" style="zoom:80%;" />
<h3 id="过滤器-filter-的使用" class="headerLink">
    <a href="#%e8%bf%87%e6%bb%a4%e5%99%a8-filter-%e7%9a%84%e4%bd%bf%e7%94%a8" class="header-mark"></a>过滤器 Filter 的使用</h3><ul>
<li>按照生命周期划分
<ul>
<li>pre 前置过滤</li>
<li>post 后置过滤</li>
</ul>
</li>
<li>按照种类划分
<ul>
<li>GatewayFilter 单一的（ 31 种）</li>
<li>GlobaFilter 全局的（ 10 种）</li>
</ul>
</li>
</ul>
<blockquote>
<p>可以查看官网：<a href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories" target="_blank" rel="noopener noreffer">Spring Cloud Gateway</a> 关于过滤器的使用</p>
</blockquote>
<ol>
<li>在 Spring 可扫描包下创建 filter.MyLogGateWayFilter 实现 <code>GlobalFilter</code>  <code>Ordered</code> 接口
<ul>
<li>在 filter 方法下写过滤条件</li>
<li>在 getOrder 方法返回当前过滤器优先级，优先级越高越先过滤</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyLogGateWayFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span><span class="o">,</span> <span class="n">Ordered</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;**************come in MyLogGateWayFilter：&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取request中的uname参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">uname</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getQueryParams</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="s">&#34;uname&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="n">uname</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;*******用户名为null，非法用户！！&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//设置响应，不被接受
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">NOT_ACCEPTABLE</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">setComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//返回chain.filter(exchange)，放行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//返回值是过滤器的优先级，越小优先级越高（最小-2147483648，最大2147483648）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>测试使用</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230316204540537.png" alt="image-20230316204540537" style="zoom:80%;" />
<h2 id="config-分布式服务配置" class="headerLink">
    <a href="#config-%e5%88%86%e5%b8%83%e5%bc%8f%e6%9c%8d%e5%8a%a1%e9%85%8d%e7%bd%ae" class="header-mark"></a>Config 分布式服务配置</h2><ul>
<li>由于微服务种单个服务的粒度相对较小，因此系统中会出现大量的服务。每套系统都需要必要的配置信息才能运行</li>
<li>所以一套集中的、动态的配置管理，为各个不同微服务应用的环境提供一种中心化的外部配置</li>
<li>SpringCLoud Config 提供动态化的配置更新，不同环境不同配置。可以在运行期间动态调整配置，服务不需要重启便可感知到配置的变化并应用新的配置</li>
<li>官网：https://docs.spring.io/spring-cloud-config/docs/current/reference/html/</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230317151444544.png" alt="image-20230317151444544" style="zoom: 33%;" />
<ul>
<li>服务端：也称微服务配置中心，是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密/解密信息等访问接口</li>
<li>客户端：通过配置中心来获取配置内容管理应用资源</li>
</ul>
<h3 id="搭建服务端配置" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba%e6%9c%8d%e5%8a%a1%e7%ab%af%e9%85%8d%e7%bd%ae" class="header-mark"></a>搭建服务端配置</h3><ol>
<li>在 Github 中创建一个名为 springcloud-config 的工程，其中配置文件命名应符合 <code>{application}-{profile}.yml</code> 写法</li>
<li>创建配置中心服务端，在 POM 中添加 config 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">    <span class="c">&lt;!-- config server --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-config-server<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="c">&lt;!-- 注册中心依赖、一般通用依赖 ... --&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>配置 YML 文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3344</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-config-center</span><span class="w"> </span><span class="c"># 注册进 Eureka 服务器的微服务名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">git</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">https://github.com/LiuJJJJN/springcloud-config.git </span><span class="w"> </span><span class="c"># git 的仓库地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">default-label</span><span class="p">:</span><span class="w"> </span><span class="l">main</span><span class="w"> </span><span class="c"># 读取的分支</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#          search-paths:   # 搜索目录</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#            - springcloud-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka  </span><span class="w"> </span><span class="c"># 服务注册到的 eureka 地址</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>配置主启动类，添加注解 <code>@EnableConfigServer</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableConfigServer</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigCenterMain3344</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ConfigCenterMain3344</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>修改 Hosts 文件添加映射</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">127.0.0.1       config-3344
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>此时访问 <code>config-3344:3344/分支名/文件名</code> 就可以看到 Github 仓库中对应文件的内容</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230317163543520.png" alt="image-20230317163543520" style="zoom:80%;" />
<h3 id="配置读取规则" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e8%af%bb%e5%8f%96%e8%a7%84%e5%88%99" class="header-mark"></a>配置读取规则</h3><img src="SpringCloud自学笔记md版.assets/image-20230317161519899.png" alt="image-20230317161519899" style="zoom:80%;" />
<ul>
<li><code>/分支名/XXX-XX.yml</code> 方式：推荐写法</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230317163543520.png" alt="image-20230317163543520" style="zoom:80%;" />
<ul>
<li><code>/XXX-XX.yml</code> 方式：使用的配置中的分支，默认 master</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230317163559558.png" alt="image-20230317163559558" style="zoom:80%;" />
<ul>
<li><code>/XXX-XX.yml/分支名</code> 方式：JSON 串</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230317163614578.png" alt="image-20230317163614578" style="zoom:80%;" />
<h3 id="搭建客户端配置" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba%e5%ae%a2%e6%88%b7%e7%ab%af%e9%85%8d%e7%bd%ae" class="header-mark"></a>搭建客户端配置</h3><ol>
<li>创建模块添加 POM 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- config client --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-config<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 注册中心依赖、一般通用依赖 ... --&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>编写 bootstrap.yml配置文件
<ul>
<li>bootstrap.yml是系统级的有更高的优先级，优先被加载，不会被本地配置覆盖</li>
<li>SpringCloud 会创建一个 Bootstrap Context 作为 Spring 应用的 Application Context 的父上下文</li>
<li>初始化的时候 Bootstrap Context 负责从外部源加载配置属性并解析配置，他俩共享一个外部获取的 Environment</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3355</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="c"># config 客户端配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l">main  </span><span class="w"> </span><span class="c"># 分支名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config   </span><span class="w"> </span><span class="c"># 配置文件名称       这三个综合 main 分支上的 config-dev.yml 的配置文件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l">dev   </span><span class="w"> </span><span class="c"># 读取后缀名称       被读取到 http://config-3344:3344/main/config/dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:3344 </span><span class="w"> </span><span class="c"># 配置中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka  </span><span class="w"> </span><span class="c">#服务注册到的eureka地址</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableEurekaClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigClientMain3355</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ConfigClientMain3355</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写控制层，使用 <code>@Value</code> 注解可读取到 bootstrap.yml 配置中对应文件的 config.info 内容</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigClientController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${config.info}&#34;</span><span class="o">)</span>   <span class="c1">// 读取 yml 配置中对应文件的 config.info 内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">configInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/configInfo&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getConfigInfo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">configInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>测试，读取成功</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230317165323053.png" alt="image-20230317165323053" style="zoom:80%;" />
<h3 id="配置动态刷新问题" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e5%8a%a8%e6%80%81%e5%88%b7%e6%96%b0%e9%97%ae%e9%a2%98" class="header-mark"></a>配置动态刷新问题</h3><ul>
<li>当 Github 上的配置文件内容修改之后，Config 服务端可以立即刷新获取到，但是 Config 客户端还是之前的配置，无法刷新到新配置（重启才能获得）</li>
</ul>
<ol>
<li>为 Config 客户端添加 Spring 服务监控依赖【除了网关之外，都应添加此依赖】</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>添加新的 YML 配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 暴露监控端点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>为业务类添加 <code>@RefreshScope</code> 注解 <strong>实现配置自动更新</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RefreshScope</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigClientController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${config.info}&#34;</span><span class="o">)</span>	<span class="c1">// 读取 yml 配置中对应文件的 config.info 内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">configInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/configInfo&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getConfigInfo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">configInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>测试，先启动 Config 客户端，再修改 Github 中文件内容，再刷新接口获取内容
<ul>
<li>此时发现：还是无效啊？？？？？？</li>
</ul>
</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230317171449457.png" alt="image-20230317171449457" style="zoom:80%;" />
<ol start="5">
<li>此时需要运维人员使用 POST 方式向 <code>http://localhost:3355/actuator/refresh</code> 发送刷新请求</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X POST http://localhost:3355/actuator/refresh
</span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230317171616907.png" alt="image-20230317171616907" style="zoom:80%;" />
<ol start="6">
<li>再刷新 Config 客户端接口，即可访问刷新后的内容</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230317171718607.png" alt="image-20230317171718607" style="zoom:80%;" />
<h2 id="bus-消息总线" class="headerLink">
    <a href="#bus-%e6%b6%88%e6%81%af%e6%80%bb%e7%ba%bf" class="header-mark"></a>Bus 消息总线</h2><ul>
<li>消息总线可以实现 <strong>微服务配置中心</strong> 的增强补充：批量刷新，广播、差异化、动态刷新</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230317175804319.png" alt="image-20230317175804319" style="zoom: 50%;" />
<blockquote>
<ol>
<li>Bus 消息总线，可以触发一个客户端节点 /bus/refresh 端点，从而刷新所有的客户端配置</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/BusToConfigClient.jpg" alt="BusToConfigClient" style="zoom:50%;" />
<ol start="2">
<li>Bug 消息总线，可以触发一个配置中心服务端 /bus/refresh 端点，从而刷新所有客户端配置</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/BusToConfigCenter.jpg" alt="BusToConfigCenter" style="zoom:50%;" />
</blockquote>
<ul>
<li>Bus 就是将 <strong>分布式系统的节点</strong> 与 <strong>轻量级消息系统</strong> 链接起来的框架</li>
<li>Bus 整合了 <strong>Java 的事件处理机制</strong> 和 <strong>消息中间件</strong> 功能</li>
<li>SpringCloud Bus 支持两种消息代理：RabbitMQ 和 Kafka</li>
</ul>
<h3 id="什么是-总线" class="headerLink">
    <a href="#%e4%bb%80%e4%b9%88%e6%98%af-%e6%80%bb%e7%ba%bf" class="header-mark"></a>什么是 总线</h3><ul>
<li>在微服务架构的系统中，通常会用轻量级的信息代理来构建一个<strong>共用的消息主题</strong>，让所有微服务实例连接到</li>
<li>由于该主题中<strong>产生的信息会被所有实例监听和消费</strong>，所以称它为<strong>消息总线</strong>，让连接在该主题的实例都收到通知</li>
</ul>
<h3 id="配置-bus-工程实现全局广播" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae-bus-%e5%b7%a5%e7%a8%8b%e5%ae%9e%e7%8e%b0%e5%85%a8%e5%b1%80%e5%b9%bf%e6%92%ad" class="header-mark"></a>配置 Bus 工程实现全局广播</h3><ol>
<li>
<p>搭建良好的 RabbitMQ 环境</p>
</li>
<li>
<p>再创建一个配置中心客户端，以便演示广播效果（参照上方 cloud-config-client-3355 模块）</p>
</li>
<li>
<p>为配置中心服务端添加信息总线</p>
<ul>
<li>这里使用 Bus 消息总线向配置中心 Center 发送刷新，为何？
<ul>
<li>如果向客户端发送刷新任务，打破了微服务的职责单一性，业务模块不应该承担配置刷新职责</li>
<li>如果向客户端发送刷新任务，破坏了微服务各个节点的对等性，业务模块集群应众生平等</li>
<li>如果向客户端发送刷新任务，有一定的局限性，服务迁移时地址变化，此时刷新需做更多修改</li>
</ul>
</li>
</ul>
</li>
<li>
<p>为配置中心服务端添加 POM 依赖</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="c">&lt;!-- 添加消息总线 RabbitMQ 的支持 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">         <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-bus-amqp<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>为配置中心服务端添加 YML 配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rabbitmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">10.211.55.17</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5672</span><span class="w"> </span><span class="c"># 客户端和 RabbitMQ 进行通信的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">  </span><span class="c"># 暴露 bus 刷新配置的监控端点</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;bus-refresh&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>为配置中心客户端添加 POM 依赖 和 YML 配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- 添加消息总线 RabbitMQ 的支持 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-bus-amqp<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">rabbitmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.30.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5672</span><span class="w"> </span><span class="c"># 客户端和 RabbitMQ 进行通信的端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 客户端原先已经暴露了 &#34;*&#34; 已经包含了 refresh 监控端点</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>启动项目，可以发现此时配置中心刷新可以获得到最新版本，但是 ConfigClient 无法刷新到最新版本配置</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230317191546341.png" alt="image-20230317191546341" style="zoom:80%;" />
<ol start="8">
<li>此时，再刷新客户端集群就都可以访问到最新配置版本了</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X POST http://localhost:3344/actuator/bus-refresh
</span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230317191859280.png" alt="image-20230317191859280" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230317191916778.png" alt="image-20230317191916778" style="zoom:80%;" />
<h3 id="配置-bus-工程实现定点通知" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae-bus-%e5%b7%a5%e7%a8%8b%e5%ae%9e%e7%8e%b0%e5%ae%9a%e7%82%b9%e9%80%9a%e7%9f%a5" class="header-mark"></a>配置 Bus 工程实现定点通知</h3><ol>
<li>向配置中心服务端发送刷新请求，并指定只刷新 3355 这个客户端</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X POST <span class="s2">&#34;http://localhost:3344/actuator/bus-refresh/config-client:3355&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230317192727855.png" alt="image-20230317192727855" style="zoom:80%;" />
<ol start="2">
<li>查看效果</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230317192808206.png" alt="image-20230317192808206" style="zoom:80%;" />
<h3 id="总结-1" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93-1" class="header-mark"></a>总结</h3><ul>
<li>在 Github 仓库更新之前，由配置中心服务端读取仓库中的配置内容，配置客户端订阅配置中心上的 Bus 消息总线消息队列</li>
<li>当 Github 仓库更新之后，配置中心即可通过 Webhook 获取到仓库中的配置内容，当程序员通过 actuator 发送刷新请求之后</li>
<li>客户端监听到消息队列中发布的刷新事件，向配置中心服务端获取配置信息</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230317192839412.png" alt="image-20230317192839412" style="zoom: 50%;" />
<h2 id="stream-消息驱动" class="headerLink">
    <a href="#stream-%e6%b6%88%e6%81%af%e9%a9%b1%e5%8a%a8" class="header-mark"></a>Stream 消息驱动</h2><ul>
<li>是一个构建消息驱动微服务的框架，为一些消息中间件产品提供了个性化的自动化配置实现，引用了：发布-订阅、消费组、分区 三个核心概念</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318125249463.png" alt="image-20230318125249463" style="zoom:80%;" />
<ul>
<li>屏蔽底层消息中间件的差异，降低切换版本，统一消息的编程模型（通过使用 Spring Integration 来连接消息代理中间件以实现消息事件驱动）</li>
</ul>
<blockquote>
<p>SpringCloud Stream 是用于构建与共享消息传递系统连接的高度可扩展的事件驱动微服务框架</p>
<ul>
<li>官网：<a href="https://spring.io/projects/spring-cloud-stream#overview" target="_blank" rel="noopener noreffer">Spring Cloud Stream</a></li>
<li>API 手册：<a href="https://docs.spring.io/spring-cloud-stream/docs/current/reference/html/" target="_blank" rel="noopener noreffer">Spring Cloud Stream Reference Documentation</a></li>
</ul>
</blockquote>
<h3 id="springcloud-stream-的设计思想" class="headerLink">
    <a href="#springcloud-stream-%e7%9a%84%e8%ae%be%e8%ae%a1%e6%80%9d%e6%83%b3" class="header-mark"></a>SpringCloud Stream 的设计思想</h3><ul>
<li>
<p>传统标准 MQ：</p>
  <img src="SpringCloud自学笔记md版.assets/image-20230318131029471.png" alt="image-20230318131029471" style="zoom: 33%;" />
<ul>
<li>生产者/消费者之间靠<strong>消息</strong>媒介传递消息内容：Message（约定好的格式：消息头、消息正文、消息附件属性）</li>
<li>消息必须走特定的<strong>通道</strong>：消息通道 MessageChannel</li>
<li>消息通道里的消息如何被消费（收发处理）：消息通道中的子接口 SubscribableChannel，由 MessageHandler 消息处理器<strong>订阅</strong></li>
</ul>
</li>
<li>
<p>引入 Stream 之后</p>
<ul>
<li>RabbitMQ 和 Kafka 架构上的不同：RabbitMQ 有 exchange，Kafka 有 Topic 和 Partitions 分区</li>
<li>通过<strong>定义 binder 绑定器作为中间层</strong>，实现了应用程序与消息中间件细节之间的<strong>解耦</strong>、<strong>隔离</strong></li>
<li>通过向应用程序<strong>暴露统一的 Channel 通道</strong>，使得应用程序不需要再考虑不同消息中间件落地实现</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318135125036.png" alt="image-20230318135125036" style="zoom:40%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230318135233146.png" alt="image-20230318135233146" style="zoom:80%;" />
<ol>
<li>Binder：绑定器，可以很方便的连接中间件，屏蔽差异</li>
<li>Channel：通道，是队列 Queue 的一种抽象，在消息通讯系统中就是实现存储和转发的媒介，通过 Channel 对队列进行配置</li>
<li>Source / Sink：从 Stream 发布消息就是输出，接受消息就是输入。简单的理解就是生产者 / 消费者</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述" style="zoom: 50%;" />
<ul>
<li>常用 API 和注解</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/StreamAPI.png" alt="StreamAPI" style="zoom: 50%;" />
<h3 id="搭建-stream-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-stream-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Stream 工程</h3><h4 id="搭建消息生产者-8801-模块" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba%e6%b6%88%e6%81%af%e7%94%9f%e4%ba%a7%e8%80%85-8801-%e6%a8%a1%e5%9d%97" class="header-mark"></a>搭建消息生产者 8801 模块</h4><ol>
<li>创建生产者模块 8801</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="c">&lt;!-- stream rabbit --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-stream-rabbit<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">		<span class="c">&lt;!-- 注册中心及一般通用依赖... --&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>配置 YML 文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8801</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-stream-provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rabbitmq</span><span class="p">:</span><span class="w"> </span><span class="c"># 由于 RabbitMQ 是配置在服务器上的, 为避免试图访问 localhost:5672 的第二次连接, 所以 rabbitmq 的相关环境配置在此配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.30.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5672</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stream</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">binders</span><span class="p">:</span><span class="w"> </span><span class="c"># 在此处配置要绑定的 rabbitmq 的服务信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">defaultRabbit</span><span class="p">:</span><span class="w"> </span><span class="c"># 表示定义的名称, 用于 binding 整合</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">rabbit</span><span class="w"> </span><span class="c"># 消息组件类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#          environment: # 设置 rabbitmq 的相关环境配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#            spring:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#              rabbitmq:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#                host: 192.168.30.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#                port: 5672</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#                username: guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#                password: guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">bindings</span><span class="p">:</span><span class="w"> </span><span class="c"># 服务的整合处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="c"># 这个名字是一个通道的名称, 表示这是一个生产者</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l">studyExchange</span><span class="w"> </span><span class="c"># 表示要使用的 Exchange 名称定义(会自动创建这个交换机)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">content-type</span><span class="p">:</span><span class="w"> </span><span class="l">application/json</span><span class="w"> </span><span class="c"># 设置消息类型，本次为 json，本文要设置为 “text/plain”</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">binder</span><span class="p">:</span><span class="w"> </span><span class="l">defaultRabbit</span><span class="w"> </span><span class="c"># 设置要绑定的消息服务的具体设置（爆红不影响使用，位置没错）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lease-renewal-interval-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 设置心跳的时间间隔（默认是30S)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lease-expiration-duration-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 如果超过 5S 间隔就注销节点 默认是90s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instance-id</span><span class="p">:</span><span class="w"> </span><span class="l">send-8801.com</span><span class="w"> </span><span class="c"># 在信息列表时显示主机名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 访问的路径变为IP地址</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StreamMQMain8801</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">StreamMQMain8801</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>创建消息发布接口</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IMessageProvider</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">send</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>实现接口，注入消息发送管道，向管道发送一条消息 UUID</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableBinding</span><span class="o">(</span><span class="n">Source</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>    <span class="c1">// 定义消息的推送管道(是生产者的输出管道)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IMessageProviderImpl</span> <span class="kd">implements</span> <span class="n">IMessageProvider</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">MessageChannel</span> <span class="n">output</span><span class="o">;</span>  <span class="c1">// 消息发送管道
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">send</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">serial</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">MessageBuilder</span><span class="o">.</span><span class="na">withPayload</span><span class="o">(</span><span class="n">serial</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>     <span class="c1">// MessageBuilder 是 spring 的 integration.support.MessageBuilder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;*******serial: &#34;</span> <span class="o">+</span> <span class="n">serial</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>编写控制层代码，调用消息发送功能</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SendMessageController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">IMessageProvider</span> <span class="n">iMessageProvider</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/sendMessage&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">sendMessage</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">iMessageProvider</span><span class="o">.</span><span class="na">send</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>此时开启消息队列、注册中心服务、生产者服务，刷新 sendMessage 接口
<ul>
<li>可以看到消息队列中有消息波峰流量</li>
</ul>
</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230318143803267.png" alt="image-20230318143803267" style="zoom:80%;" />
<h4 id="搭建消息消费者-88028803-模块" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba%e6%b6%88%e6%81%af%e6%b6%88%e8%b4%b9%e8%80%85-88028803-%e6%a8%a1%e5%9d%97" class="header-mark"></a>搭建消息消费者 8802、8803 模块</h4><ol>
<li>创建消费者 8802 工程</li>
<li>POM 文件同上方生产者</li>
<li>配置 YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8802</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-stream-provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rabbitmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.30.129</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">5672</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">guest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">stream</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">binders</span><span class="p">:</span><span class="w"> </span><span class="c"># 在此处配置要绑定的 rabbitmq 的服务信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">defaultRabbit</span><span class="p">:</span><span class="w"> </span><span class="c"># 表示定义的名称，用于 binding 整合</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">rabbit</span><span class="w"> </span><span class="c"># 消息组件类型</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">bindings</span><span class="p">:</span><span class="w"> </span><span class="c"># 服务的整合处理</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">input</span><span class="p">:</span><span class="w"> </span><span class="c"># 这个名字是一个通道的名称 **其它和生产者一样, 就是这里 output 变为 input**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l">studyExchange</span><span class="w"> </span><span class="c"># 表示要使用的 Exchange 名称定义</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">content-type</span><span class="p">:</span><span class="w"> </span><span class="l">application/json</span><span class="w"> </span><span class="c"># 设置消息类型, 本次为 json，本文要设置为 “text/plain”</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">binder</span><span class="p">:</span><span class="w"> </span><span class="l">defaultRabbit</span><span class="w"> </span><span class="c"># 设置要绑定的消息服务的具体设置（爆红不影响使用，位置没错）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lease-renewal-interval-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 设置心跳的时间间隔（默认是30S)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lease-expiration-duration-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 如果超过 5S 间隔就注销节点 默认是 90s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instance-id</span><span class="p">:</span><span class="w"> </span><span class="l">receive-8802.com</span><span class="w"> </span><span class="c"># 在信息列表时显示主机名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 访问的路径变为 IP 地址</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>
<p>配置主启动类同上方生产者</p>
</li>
<li>
<p>编写消息监听控制层</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableBinding</span><span class="o">(</span><span class="n">Sink</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 定义消息的接收管道(是消费者的输入管道)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Controller</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReceiveMessageListenerController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@StreamListener</span><span class="o">(</span><span class="n">Sink</span><span class="o">.</span><span class="na">INPUT</span><span class="o">)</span> <span class="c1">// 监听
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">input</span><span class="o">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;消费者1号------&gt;收到的消息：&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="na">getPayload</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t port：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>测试启动 8802 消费者，此时刷新 8801 的消息发布接口，可以看到 8802 消费者的控制台输出了对应内容，并且可以看到有服务绑定了队列交换机</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230318145544422.png" alt="image-20230318145544422" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230318145559478.png" alt="image-20230318145559478" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230318145355062.png" alt="image-20230318145355062" style="zoom:80%;" />
<ol>
<li>根据上方步骤创建 8803 消费者模块，注意更改端口号、eureka 主机名避免重复</li>
<li><strong>重复消费问题</strong>：当 8801 生产者刷新接口发布消息之后，8802、8803 都接收到了数据进行了消费</li>
</ol>
<img src="SpringCloud自学笔记md版.assets/image-20230318151047260.png" alt="image-20230318151047260" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230318151101053.png" alt="image-20230318151101053" style="zoom:80%;" />
<h3 id="重复消费" class="headerLink">
    <a href="#%e9%87%8d%e5%a4%8d%e6%b6%88%e8%b4%b9" class="header-mark"></a>重复消费</h3><ul>
<li>如果是订单系统，有多个消费者都获取到了订单信息，造成重复消费查复扣款，问题严重</li>
<li>这种情况可以由 <strong>消息分组</strong> 解决：同一个组内会发生竞争关系，只能有一个消费者可以消费</li>
<li>主题会给每个队列发送消息，而每个队列只有一个消费者可以获得消息（同组广播，不同组轮询）</li>
</ul>
<p>消费者 8002、8003 组流水号不一致，被认为不同组（这里的流水号就是组名，默认没设置就这样）</p>
<img src="SpringCloud自学笔记md版.assets/image-20230318151714767.png" alt="image-20230318151714767" style="zoom:80%;" />
<ul>
<li>为两个消费者都设置 group 属性，并指定相同的 group 名即可解决</li>
</ul>
<p><img
        class="lazyload"
        data-src="SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230318152040327.png"
        data-srcset="SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230318152040327.png, SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230318152040327.png 1.5x, SpringCloud%e8%87%aa%e5%ad%a6%e7%ac%94%e8%ae%b0md%e7%89%88.assets/image-20230318152040327.png 2x"
        data-sizes="auto"
        alt="SpringCloud自学笔记md版.assets/image-20230318152040327.png"
        title="image-20230318152040327"></p>
<img src="SpringCloud自学笔记md版.assets/image-20230318152254301.png" alt="image-20230318152254301" style="zoom:80%;" />
<ul>
<li>此时刷新两次发送消息接口，8802 和 8803 各接收到一条信息</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318152320096.png" alt="image-20230318152320096" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230318152331357.png" alt="image-20230318152331357" style="zoom:80%;" />
<img src="SpringCloud自学笔记md版.assets/image-20230318152342317.png" alt="image-20230318152342317" style="zoom:80%;" />
<h3 id="消息持久化" class="headerLink">
    <a href="#%e6%b6%88%e6%81%af%e6%8c%81%e4%b9%85%e5%8c%96" class="header-mark"></a>消息持久化</h3><ul>
<li>
<p>在停掉所有消费者的情况下发送消息、</p>
<ul>
<li>如果消费者 8802 去除了分组，则重启后无法获取消息</li>
<li>如果消费者 8803 保留了分组，则重启后可以获取消息</li>
</ul>
<blockquote>
<p>因为 8803 没删除 <code>group: groupA</code> ，groupA 队列是在 8801 发送消息前存在的，所以当 8803 停机后再启动，就可以获取到停机时 8801 发送的信息</p>
<p>（ 如果此时同组（队列）里有别的消费者，那么消息会被别的消费者消费掉 ）</p>
</blockquote>
</li>
</ul>
<h2 id="sleuth-分布式链路追踪" class="headerLink">
    <a href="#sleuth-%e5%88%86%e5%b8%83%e5%bc%8f%e9%93%be%e8%b7%af%e8%bf%bd%e8%b8%aa" class="header-mark"></a>Sleuth 分布式链路追踪</h2><ul>
<li>在微服务架构中，每个请求都要经过多个不同的服务节点协同调用才产生最后的请求结果，链路中任意一环出现高延时或错误都会引起整个请求的响应失败</li>
<li>SpringCloud Sleuth 提供了一套完整的服务跟踪的解决方案，并且支持 zipkin</li>
<li>官网：<a href="https://spring.io/projects/spring-cloud-sleuth#overview" target="_blank" rel="noopener noreffer">Spring Cloud Sleuth</a> <a href="https://github.com/spring-cloud/spring-cloud-sleuth" target="_blank" rel="noopener noreffer">spring-cloud/spring-cloud-sleuth: Distributed tracing for spring cloud (github.com)</a></li>
</ul>
<h3 id="如何使用" class="headerLink">
    <a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8" class="header-mark"></a>如何使用</h3><ul>
<li>下载 zipkin 的 jar 包：<a href="https://repo1.maven.org/maven2/io/zipkin/zipkin-server/" target="_blank" rel="noopener noreffer">Central Repository: io/zipkin/zipkin-server (maven.org)</a></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318161756735.png" alt="image-20230318161756735" style="zoom:80%;" />
<ul>
<li>打开命令行使用 java -jar 命令运行 jar 包</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">java -jar .\zipkin-server-2.24.0-exec.jar
</span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230318162441471.png" alt="image-20230318162441471" style="zoom:67%;" />
<ul>
<li>启动后访问 <code>http://localhost:9411/zipkin/</code></li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318162517100.png" alt="image-20230318162517100" style="zoom:67%;" />
<ul>
<li>每条链路有一个 trace ID 唯一标识，span 标识发起的请求信息，各个 span 通过 trace ID 关联起来
<ul>
<li>Trace：类似于树结构的 Span 集合，表示一条调用链路存在的唯一标识</li>
<li>Span：标识每次调用链路来源，说白了 Span 就是一次请求信息</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318162749114.png" alt="image-20230318162749114" style="zoom: 50%;" />
<img src="SpringCloud自学笔记md版.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70-1679128394136-7.png" alt="在这里插入图片描述" style="zoom: 67%;" />
<h3 id="搭建链路追踪步骤" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba%e9%93%be%e8%b7%af%e8%bf%bd%e8%b8%aa%e6%ad%a5%e9%aa%a4" class="header-mark"></a>搭建链路追踪步骤</h3><ul>
<li>为服务生产者添加 POM 依赖</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="c">&lt;!-- 包含了 sleuth + zipkin --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">           <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>为服务生产者添加 YML 配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">zipkin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">base-url</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:9411</span><span class="w"> </span><span class="c"># 将监控的数据打到这个地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sleuth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sampler</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">probability</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">  </span><span class="c"># 采样率值介于 0 到 1 之间, 1则表示全部采集（一般不为 1, 不然高并发性能会有影响）</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><img src="SpringCloud自学笔记md版.assets/image-20230318163718838.png" alt="image-20230318163718838" style="zoom: 80%;" />
<ul>
<li>
<p>为服务消费者也添加同样的配置</p>
</li>
<li>
<p>启动注册中心、生产者、消费者服务，访问消费者接口调用生产者，刷新 zipkin 页面</p>
<ul>
<li>可以看到这次请求的请求路径、请求时间、花费时长</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318164558409.png" alt="image-20230318164558409" style="zoom:80%;" />
<ul>
<li>点击 show 按钮
<ul>
<li>可以看到是哪个消费者接口调用的哪个生产者接口，各自的信息</li>
</ul>
</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318164706401.png" alt="image-20230318164706401" style="zoom:80%;" />
<ul>
<li>点击依赖标签页，可以看到各个模块间的依赖关系图示</li>
</ul>
<img src="SpringCloud自学笔记md版.assets/image-20230318164836611.png" alt="image-20230318164836611" style="zoom:80%;" />
<h2 id="springcloud-alibaba-部分" class="headerLink">
    <a href="#springcloud-alibaba-%e9%83%a8%e5%88%86" class="header-mark"></a>SpringCloud Alibaba 部分</h2><ul>
<li>
<p>官网：https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</p>
</li>
<li>
<p>于 2018.10.31 在 Maven 中央仓库发布了第一个版本 0.2.0</p>
</li>
</ul>
<h3 id="springcloud-alibaba-能干什么" class="headerLink">
    <a href="#springcloud-alibaba-%e8%83%bd%e5%b9%b2%e4%bb%80%e4%b9%88" class="header-mark"></a>SpringCloud Alibaba 能干什么</h3><ul>
<li><strong>服务限流降级</strong>：默认支持 WebServlet、WebFlux、OpenFeign、RestTemplate、Spring Cloud Gateway、Zuul、Dubbo 和 RocketMQ 限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级 Metrics 监控。</li>
<li><strong>服务注册与发现</strong>：适配 Spring Cloud 服务注册与发现标准，默认集成了 Ribbon 的支持。</li>
<li><strong>分布式配置管理</strong>：支持分布式系统中的外部化配置，配置更改时自动刷新。</li>
<li><strong>消息驱动能力</strong>：基于 Spring Cloud Stream 为微服务应用构建消息驱动能力。</li>
<li><strong>分布式事务</strong>：使用 @GlobalTransactional 注解， 高效并且对业务零侵入地解决分布式事务问题。</li>
<li><strong>阿里云对象存储</strong>：阿里云提供的海量、安全、低成本、高可靠的云存储服务。支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li>
<li><strong>分布式任务调度</strong>：提供秒级、精准、高可靠、高可用的定时（基于 Cron 表达式）任务调度服务。同时提供分布式的任务执行模型，如网格任务。网格任务支持海量子任务均匀分配到所有 Worker（schedulerx-client）上执行。</li>
<li><strong>阿里云短信服务</strong>：覆盖全球的短信服务，友好、高效、智能的互联化通讯能力，帮助企业迅速搭建客户触达通道。</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230321213751678.png" alt="image-20230321213751678" style="zoom:67%;" />
<h3 id="nacos-作为服务注册" class="headerLink">
    <a href="#nacos-%e4%bd%9c%e4%b8%ba%e6%9c%8d%e5%8a%a1%e6%b3%a8%e5%86%8c" class="header-mark"></a>Nacos 作为服务注册</h3><ul>
<li>Nacos：naming（na），Configuration（co），service（s）</li>
<li>Dynamic Naming and Configuration Service：一个更易于构建云原生应用的动态服务发现，配置管理和服务管理平台</li>
<li>Nacos 等价于：eureka + config + Bus</li>
<li>官网：<a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener noreffer">home (nacos.io)</a></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230321224500498.png" alt="image-20230321224500498" style="zoom: 33%;" />
<img src="https://img-blog.csdnimg.cn/20200619192441543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<img src="https://img-blog.csdnimg.cn/20200619192453900.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230321224702400.png" alt="image-20230321224702400" style="zoom: 67%;" />
<h4 id="安装-nacos" class="headerLink">
    <a href="#%e5%ae%89%e8%a3%85-nacos" class="header-mark"></a>安装 Nacos</h4><ol>
<li>
<p>获取 Nacos：<a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener noreffer">Releases · alibaba/nacos (github.com)</a></p>
</li>
<li>
<p>解压，打开 bin 目录</p>
</li>
<li>
<p>运行 cmd <code>startup.cmd -m standalone</code></p>
</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325163338355.png" alt="image-20230325163338355" style="zoom:80%;" />
<ol start="4">
<li>访问 <code>http://localhost:8848/nacos/</code> 即可
<ul>
<li>默认账号：nacos</li>
<li>默认密码：nacos</li>
</ul>
</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325163427604.png" alt="image-20230325163427604" style="zoom:80%;" />
<h4 id="搭建-nacos-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-nacos-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Nacos 工程</h4><p>官网：<a href="https://spring-cloud-alibaba-group.github.io/github-pages/greenwich/spring-cloud-alibaba.html#_spring_cloud_alibaba_nacos_discovery" target="_blank" rel="noopener noreffer">Spring Cloud Alibaba Reference Documentation (spring-cloud-alibaba-group.github.io)</a></p>
<h5 id="配置服务生产者" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e6%9c%8d%e5%8a%a1%e7%94%9f%e4%ba%a7%e8%80%85" class="header-mark"></a>配置服务生产者</h5><ol>
<li>新建工程 cloudalibaba-provider-payment9001</li>
<li>添加 Nacos 的 discovery 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- SpringCloud Alibaba nacos --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>配置 YML 文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nacos-payment-provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w">  </span><span class="c"># 配置的 Nacos 地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写主启动类，添加 <code>@EnableDiscoveryClient</code> 注解</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain9001</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain9001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>编写控制层 &hellip;</li>
<li>启动项目，在 nacos 浏览器界面 服务管理 &gt; 服务列表 中即可看到</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325210512779.png" alt="image-20230325210512779" style="zoom:80%;" />
<h5 id="配置服务生产者2" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e6%9c%8d%e5%8a%a1%e7%94%9f%e4%ba%a7%e8%80%852" class="header-mark"></a>配置服务生产者2</h5><ul>
<li>投机取巧，使用 IDEA 的 Copy 功能</li>
</ul>
<ol>
<li>右键一个实例，选择 Copy Configuration</li>
</ol>
<p><img
        class="lazyload"
        data-src="C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230325211037511.png"
        data-srcset="C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230325211037511.png, C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230325211037511.png 1.5x, C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230325211037511.png 2x"
        data-sizes="auto"
        alt="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325211037511.png"
        title="image-20230325211037511"></p>
<ol start="2">
<li>设置名称、添加 VM Options 值 <code>-DServer.port=9011</code></li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325210913562.png" alt="image-20230325210913562" style="zoom:80%;" />
<ol start="3">
<li>此时在 nacos 的界面中即可看到实例数为 2</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325211212344.png" alt="image-20230325211212344" style="zoom:80%;" />
<h5 id="配置服务消费者" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e6%9c%8d%e5%8a%a1%e6%b6%88%e8%b4%b9%e8%80%85" class="header-mark"></a>配置服务消费者</h5><ol>
<li>创建 cloudalibaba-consumer-nacos-order83</li>
<li>添加 POM 依赖</li>
<li>编写 YML 配置，注意配置生产者的微服务名称</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">83</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nacos-order-consumer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w">  </span><span class="c"># 配置的 Nacos 地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 消费者要访问的微服务名称（成功注册进 nacos 的服务提供者）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nacos-user-service</span><span class="p">:</span><span class="w"> </span><span class="l">http://nacos-payment-provider</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写主启动类
<ul>
<li>如果使用 RestTemplate 则需要编写配置类将 Bean 注入到 Spring 容器中  <a href='#RestTemplateConfig'>配置方式</a></li>
<li>此时就可以用 <code>@Value</code> 读取 YML 中的服务提供者别名作为 serverURL</li>
</ul>
</li>
<li>编写控制层代码</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325215817521.png" alt="image-20230325215817521" style="zoom: 67%;" />
<ul>
<li>此时可以看到 nacos 中注册进了新的服务</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325215912879.png" alt="image-20230325215912879" style="zoom:80%;" />
<h6 id="使用-feign" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8-feign" class="header-mark"></a>使用 Feign</h6><ol>
<li>加入 OpenFeign 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">    <span class="c">&lt;!-- OpenFeign --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>在启动类上添加注解激活 Feign <code>@EnableFeignClients</code></p>
</li>
<li>
<p>取消配置类中的 RestTemplate 相关配置</p>
</li>
<li>
<p>创建接口 <code>PaymentFeignService</code> 、使用 <a href='#OpenFeignService'>参照代码</a></p>
</li>
</ol>
<h4 id="ap-or-cp" class="headerLink">
    <a href="#ap-or-cp" class="header-mark"></a>AP or CP</h4><ul>
<li>前面有说 nacos 是支持 CAP 中的 AP，即 可用性 和 分区容错性</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331153703410.png" alt="image-20230331153703410" style="zoom: 50%;" />
<ul>
<li>但是实际上 nacos 是可以根据业务选型切换 AP 和 CP 两种模式的，如下图所示，左侧即 AP 右侧即 CP</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325222633777.png" alt="image-20230325222633777" style="zoom: 40%;" />
<ul>
<li>一般情况下只需保持心跳上报的项目默认就是 AP 模式，AP 模式为了服务的可用性减弱了一致性，因此在此模式下只支持注册临时实例</li>
<li>如果需要在服务级别编辑或存储配置信息，那么 CP 是必须。CP 模式下支持注册持久化实例（是以 Raft 协议为集群运行&hellip;）</li>
<li>切换模式：<code>curl -X PUT '$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&amp;value=CP'</code></li>
</ul>
<h4 id="与其他注册中心特性对比" class="headerLink">
    <a href="#%e4%b8%8e%e5%85%b6%e4%bb%96%e6%b3%a8%e5%86%8c%e4%b8%ad%e5%bf%83%e7%89%b9%e6%80%a7%e5%af%b9%e6%af%94" class="header-mark"></a>与其他注册中心特性对比</h4><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230325223046353.png" alt="image-20230325223046353" style="zoom: 50%;" />
<h3 id="nacos-作为配置中心" class="headerLink">
    <a href="#nacos-%e4%bd%9c%e4%b8%ba%e9%85%8d%e7%bd%ae%e4%b8%ad%e5%bf%83" class="header-mark"></a>Nacos 作为配置中心</h3><h4 id="搭建-nacos-工程-1" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-nacos-%e5%b7%a5%e7%a8%8b-1" class="header-mark"></a>搭建 Nacos 工程</h4><ol>
<li>创建模块 cloudalibaba-config-nacos-client3377</li>
<li>添加 Nacos 的 config 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- nacos config --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- nacos discovery --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>配置 bootstrap.yml 和 application.yml
<ul>
<li>bootstrap.yml 的优先级高于 application.yml，所以在项目初始化时保证先从配置中心拉去配置信息</li>
<li>这里的意思就是 <strong>从 <code>localhost:8848</code> 获取 yml 格式的 dev 环境的配置</strong></li>
</ul>
</li>
</ol>
<ul>
<li>bootstrap.yml</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3377</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nacos-config-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c"># Nacos 服务注册中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c"># Nacos 作为配置中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file-extension</span><span class="p">:</span><span class="w"> </span><span class="l">yml</span><span class="w"> </span><span class="c"># 指定 yml 格式配置</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>application.yml</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w"> </span><span class="c"># 表示开发环境</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>配置主启动类 NacosConfigClientMain3377</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NacosConfigClientMain3377</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">NacosConfigClientMain3377</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>编写控制层代码，标注 @RefreshScope 让其支持配置自动更新</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RefreshScope</span>   <span class="c1">// 支持 Nacos 的动态刷新功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigClientController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${config.info}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">configInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/config/info&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getConfigInfo</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">configInfo</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="配置规则公式" class="headerLink">
    <a href="#%e9%85%8d%e7%bd%ae%e8%a7%84%e5%88%99%e5%85%ac%e5%bc%8f" class="header-mark"></a>配置规则公式</h4><ul>
<li>见 Nacos 官网 <a href="https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html" target="_blank" rel="noopener noreffer">https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html</a></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331160159086.png" alt="image-20230331160159086" style="zoom: 67%;" />
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="si">${</span><span class="nv">prefix</span><span class="si">}</span>-<span class="si">${</span><span class="nv">spring</span><span class="p">.profiles.active</span><span class="si">}</span>.<span class="si">${</span><span class="nv">file</span><span class="p">-extension</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 也就是</span>
</span></span><span class="line"><span class="cl"><span class="si">${</span><span class="nv">spring</span><span class="p">.application.name</span><span class="si">}</span>-<span class="si">${</span><span class="nv">spring</span><span class="p">.profiles.active</span><span class="si">}</span>.<span class="si">${</span><span class="nv">spring</span><span class="p">.cloud.nacos.config.file-extension</span><span class="si">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>由此公式最终可以组成 <code>nacos-config-client-dev.yml</code></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331161116285.png" alt="image-20230331161116285" style="zoom: 80%;" />
<ol>
<li>点击加号添加一个配置</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331160700474.png" alt="image-20230331160700474" style="zoom:80%;" />
<ol start="2">
<li>Data ID 就是 <code>nacos-config-client-dev.yml</code></li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331161046180.png" alt="image-20230331161046180" style="zoom:80%;" />
<ol start="3">
<li>此时运行 3377 项目，访问控制层方法即可获取到在 nacos 中配置的内容</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331161433728.png" alt="image-20230331161433728" style="zoom:80%;" />
<p>4.此时修改 nacos 中的配置信息，再次刷新控制层接口【<strong>动态刷新</strong>】不像 Config 需要手动刷新</p>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331161645499.png" alt="image-20230331161645499" style="zoom:80%;" />
<h4 id="分类配置" class="headerLink">
    <a href="#%e5%88%86%e7%b1%bb%e9%85%8d%e7%bd%ae" class="header-mark"></a>分类配置</h4><ul>
<li>
<p>通常在实际开发中会有多种环境</p>
<ul>
<li>dev 开发环境、test 测试环境、prod 生产环境、预发环境、正式环境 &hellip;&hellip;</li>
<li>此时就需要对不同的环境进行配置管理</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331163550500.png" alt="image-20230331163550500" style="zoom:80%;" />
</li>
<li>
<p>Namespace 命名空间 &gt; Group 组 &gt; Data ID 配置：三者的关系</p>
<ul>
<li>默认情况：Namespace=public、Group=DEFAULT_GROUP、Cluster=DEFAULT</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331162642679.png" alt="image-20230331162642679" style="zoom:50%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331163051252.png" alt="image-20230331163051252" style="zoom: 38%;" />
<ul>
<li>Namespace 实现隔离，不同的环境用不同的 Namespace</li>
<li>Group 中可以包含多个微服务 Service</li>
<li>Service 中包含多个 Cluster （集群，是对指定微服务的一个虚拟划分）</li>
<li>Instance 就是微服务的实例</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331163323601.png" alt="image-20230331163323601" style="zoom: 40%;" />
<h5 id="data-id-方案" class="headerLink">
    <a href="#data-id-%e6%96%b9%e6%a1%88" class="header-mark"></a>Data ID 方案</h5><ul>
<li>在默认 Namespace 默认 Group 下创建测试环境 Data ID</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331195625999.png" alt="image-20230331195625999" style="zoom:80%;" />
<ul>
<li>修改 application.yml 内容</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># active: dev # 表示开发环境</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w"> </span><span class="c"># 表示测试环境</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>就可以读取到对应配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="si">${</span><span class="nv">spring</span><span class="p">.application.name</span><span class="si">}</span>-<span class="si">${</span><span class="nv">spring</span><span class="p">.profiles.active</span><span class="si">}</span>.<span class="si">${</span><span class="nv">spring</span><span class="p">.cloud.nacos.config.file-extension</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 也就是 public &gt; DEFAULT_GROUP &gt; nacos-config-client-test.yml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="group-方案" class="headerLink">
    <a href="#group-%e6%96%b9%e6%a1%88" class="header-mark"></a>Group 方案</h5><ul>
<li>在默认 Namespace 中创建不同的 Group 组，在组中创建相同的 Data ID</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331200820800.png" alt="image-20230331200820800" style="zoom:80%;" />
<ul>
<li>修改 bootstrap.yml 中内容，添加 <code>spring.cloud.nacos.config.group</code> 配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3377</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nacos-config-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c"># Nacos 服务注册中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c"># Nacos 作为配置中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file-extension</span><span class="p">:</span><span class="w"> </span><span class="l">yml</span><span class="w"> </span><span class="c"># 指定 yml 格式配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">TEST_GROUP</span><span class="w"> </span><span class="c"># 指定从 TEST_GROUP 中读取配置</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>修改 application.yml 内容</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># active: dev # 表示开发环境</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">info</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>就可以读取到对应配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="si">${</span><span class="nv">spring</span><span class="p">.application.name</span><span class="si">}</span>-<span class="si">${</span><span class="nv">spring</span><span class="p">.profiles.active</span><span class="si">}</span>.<span class="si">${</span><span class="nv">spring</span><span class="p">.cloud.nacos.config.file-extension</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 也就是 public &gt; DEFAULT_GROUP &gt; nacos-config-client-info.yml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="namespace-方案" class="headerLink">
    <a href="#namespace-%e6%96%b9%e6%a1%88" class="header-mark"></a>Namespace 方案</h5><ul>
<li>创建新的命名空间</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331201552196.png" alt="image-20230331201552196" style="zoom:80%;" />
<ul>
<li>在配置列表中即可看到新增的命名空间</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331201613722.png" alt="image-20230331201613722" style="zoom:80%;" />
<ul>
<li>修改 bootstrap.yml 中内容，添加 <code>spring.cloud.nacos.config.namespace</code> 配置为新命名空间 ID</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">3377</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nacos-config-client</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c"># Nacos 服务注册中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c"># Nacos 作为配置中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file-extension</span><span class="p">:</span><span class="w"> </span><span class="l">yml</span><span class="w"> </span><span class="c"># 指定 yml 格式配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l">TEST_GROUP</span><span class="w"> </span><span class="c"># 指定从 TEST_GROUP 中读取配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">d18b3fba-17d6-4492-b9e5-00d0d72ba771</span><span class="w"> </span><span class="c"># 指定从此 ID 的 namespace 中读取配置</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>就可以读取到对应配置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="si">${</span><span class="nv">spring</span><span class="p">.application.name</span><span class="si">}</span>-<span class="si">${</span><span class="nv">spring</span><span class="p">.profiles.active</span><span class="si">}</span>.<span class="si">${</span><span class="nv">spring</span><span class="p">.cloud.nacos.config.file-extension</span><span class="si">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 也就是 DEV &gt; TEST_GROUP &gt; nacos-config-client-dev.yml</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nacos-集群和持久化配置" class="headerLink">
    <a href="#nacos-%e9%9b%86%e7%be%a4%e5%92%8c%e6%8c%81%e4%b9%85%e5%8c%96%e9%85%8d%e7%bd%ae" class="header-mark"></a>Nacos 集群和持久化配置</h3><ul>
<li>下图的 SLB 在旧版图片中就是 VIP，官网：<a href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html" target="_blank" rel="noopener noreffer">集群部署说明 (nacos.io)</a></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331203937701.png" alt="image-20230331203937701" style="zoom:80%;" />
<ul>
<li>Nacos 默认使用内嵌 Derby 数据库，但是在集群环境下，启动多个默认配置下的 nacos 节点，数据存储存在一致性问题。</li>
<li>因此需要使用集中存储的方式来支持集群化存储，需要 MySQL 数据库</li>
</ul>
<h4 id="单机模式支持-mysql" class="headerLink">
    <a href="#%e5%8d%95%e6%9c%ba%e6%a8%a1%e5%bc%8f%e6%94%af%e6%8c%81-mysql" class="header-mark"></a>单机模式支持 MySQL</h4><ul>
<li>官网说明：<a href="https://nacos.io/zh-cn/docs/deployment.html" target="_blank" rel="noopener noreffer">Nacos支持三种部署模式</a></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331205523983.png" alt="image-20230331205523983" style="zoom:80%;" />
<ol>
<li>修改 conf 目录中 <code>application.properties</code> 配置文件</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331205809255.png" alt="image-20230331205809255" style="zoom:80%;" />
<ol start="2">
<li>导入 conf 下 <code>nacos-mysql.sql</code> 文件到本地数据库</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331210019234.png" alt="image-20230331210019234" style="zoom:80%;" />
<ol start="3">
<li>此时开启服务即可发现，此前的配置全部消失了，因为此时用的是本机的 MySQL 数据库中没有数据</li>
</ol>
<h4 id="linux-集群生产环境配置" class="headerLink">
    <a href="#linux-%e9%9b%86%e7%be%a4%e7%94%9f%e4%ba%a7%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae" class="header-mark"></a>Linux 集群生产环境配置</h4><ul>
<li>
<p>由于我虚拟机 Linux 中运行 Docker 的 Nacos 一直自动结束运行，一时间没调好，很气，故此处略</p>
</li>
<li>
<p>大致步骤：</p>
<ul>
<li>安装 MySQL 创建数据库并 Source 进 Nacos 的 sql 文件</li>
<li>修改 application.properties 配置数据库地址、用户名、密码等</li>
<li>修改 nacos 的集群配置 cluster.conf</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331211858620.png" alt="image-20230331211858620" style="zoom: 80%;" />
<ul>
<li>通过编辑 nacos 的启动脚本startup.sh 使它能够使用不同的端口启动</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331212102007.png" alt="image-20230331212102007" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331212121983.png" alt="image-20230331212121983" style="zoom:80%;" />
<ul>
<li>修改 nginx.conf 使其作为负载均衡器</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230331212214948.png" alt="image-20230331212214948" style="zoom:80%;" />
<ul>
<li>测试访问：http://IP:1111/nacos/#/login</li>
</ul>
</li>
</ul>
<img src="https://img-blog.csdnimg.cn/20200624181328483.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<h3 id="sentinel-熔断与限流" class="headerLink">
    <a href="#sentinel-%e7%86%94%e6%96%ad%e4%b8%8e%e9%99%90%e6%b5%81" class="header-mark"></a>Sentinel 熔断与限流</h3><ul>
<li>中文文档：<a href="https://sentinelguard.io/zh-cn/docs/introduction.html" target="_blank" rel="noopener noreffer">introduction | Sentinel (sentinelguard.io)</a></li>
<li>Github：<a href="https://github.com/alibaba/Sentinel" target="_blank" rel="noopener noreffer">alibaba/Sentinel: 面向云原生微服务的高可用流控防护组件 (github.com)</a></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401202249913.png" alt="image-20230401202249913" style="zoom:80%;" />
<img src="https://img-blog.csdnimg.cn/20200627192938903.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom: 50%;" />
<img src="https://img-blog.csdnimg.cn/20200627193019324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<ul>
<li>Sentinel 用来解决：服务雪崩、服务降级、服务熔断、服务限流</li>
<li>Sentinel 分为两个部分
<ul>
<li>核心库（ Java 客户端）不依赖任何框架 / 库，能够运行于所有 Java 运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持</li>
<li>控制台（ DashBoard ）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器</li>
</ul>
</li>
</ul>
<h4 id="运行-sentinel" class="headerLink">
    <a href="#%e8%bf%90%e8%a1%8c-sentinel" class="header-mark"></a>运行 Sentinel</h4><ul>
<li>运行前提：Java 8 环境，8080 端口没有被占用</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">java -jar .<span class="se">\s</span>entinel-dashboard-1.8.6.jar
</span></span></code></pre></td></tr></table>
</div>
</div><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401203755800.png" alt="image-20230401203755800" style="zoom:80%;" />
<ul>
<li>访问 <code>http://localhost:8080/</code> 即可看到 Sentinel 界面
<ul>
<li>用户：sentinel</li>
<li>密码：sentinel</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401203831845.png" alt="image-20230401203831845" style="zoom:80%;" />
<h4 id="搭建-sentinel-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-sentinel-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Sentinel 工程</h4><ol>
<li>创建模块 cloudalibaba-sentinel-service8401</li>
<li>配置 POM 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">		<span class="c">&lt;!-- SpringCloud alibaba nacos --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringCloud alibaba sentinel-datasource-nacos 持久化需要用到 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.csp<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>sentinel-datasource-nacos<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringCloud alibaba sentinel --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>配置 YML 文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8401</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudalibaba-sentinel-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># Nacos 服务注册中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sentinel</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transport</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#配置 Sentinel dashboard 地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">dashboard</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># 默认 8719 端口，假如被占用了会自动从 8719 端口 +1 进行扫描，直到找到未被占用的端口【通信服务（后台监控服务）】</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8719</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainApp8401</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">MainApp8401</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>编写控制层</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401205312102.png" alt="image-20230401205312102" style="zoom:80%;" />
<ol start="6">
<li>由于 Sentinel 采用懒加载机制，需要调用一次接口才能显示</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401210221874.png" alt="image-20230401210221874" style="zoom:80%;" />
<ol start="7">
<li>在簇点链路中就可以看到接口之间的调用关系</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401210517603.png" alt="image-20230401210517603" style="zoom:80%;" />
<h4 id="流控规则流量控制规则" class="headerLink">
    <a href="#%e6%b5%81%e6%8e%a7%e8%a7%84%e5%88%99%e6%b5%81%e9%87%8f%e6%8e%a7%e5%88%b6%e8%a7%84%e5%88%99" class="header-mark"></a>流控规则（流量控制规则）</h4><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401211303699.png" alt="image-20230401211303699" style="zoom:80%;" />
<h5 id="直接" class="headerLink">
    <a href="#%e7%9b%b4%e6%8e%a5" class="header-mark"></a>直接</h5><ul>
<li>可以在簇点链路界面中快速对一个接口添加流控</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401211659564.png" alt="image-20230401211659564" style="zoom:80%;" />
<ul>
<li>此时 一秒内 点击了多次就会显示 Sentinel 的提示【默认报错】</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230401211813461.png" alt="image-20230401211813461" style="zoom:80%;" />
<h5 id="关联" class="headerLink">
    <a href="#%e5%85%b3%e8%81%94" class="header-mark"></a>关联</h5><ul>
<li>当关联的资源达到阈值时，就限流自己（例如当支付接口达到阈值时就限流下订单的接口）</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403131112984.png" alt="image-20230403131112984" style="zoom:80%;" />
<ul>
<li>当 /testB 达到阈值 QPS 1 时，/testA 限流</li>
<li>使用 postman 进行并发访问</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403131624479.png" alt="image-20230403131624479" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403131704651.png" alt="image-20230403131704651" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403131823678.png" alt="image-20230403131823678" style="zoom:80%;" />
<ul>
<li>此时 /testA 接口已经被限流</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403131911720.png" alt="image-20230403131911720" style="zoom:80%;" />
<h5 id="链路" class="headerLink">
    <a href="#%e9%93%be%e8%b7%af" class="header-mark"></a>链路</h5><ul>
<li>链路就是对一个指定资源进行限流，并且是某个接口调用的这个资源，对这个调用链路进行限流</li>
<li>此处没有测试出效果，略</li>
<li>angenin 的笔记：<a href="https://blog.csdn.net/qq_36903261/article/details/106899215#%e9%93%be%e8%b7%af" target="_blank" rel="noopener noreffer">最新的SpringCloud(H版&amp;Alibaba)技术（19高级部分，熔断与限流【Sentinel】）_angenin的博客-CSDN博客</a></li>
</ul>
<h5 id="快速失败" class="headerLink">
    <a href="#%e5%bf%ab%e9%80%9f%e5%a4%b1%e8%b4%a5" class="header-mark"></a>快速失败</h5><ul>
<li>在 com.alibaba.csp.sentinel.slots.block.flow.controller.DefaultController 类中处理，抛出异常</li>
</ul>
<p><img
        class="lazyload"
        data-src="C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230403132730077.png"
        data-srcset="C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230403132730077.png, C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230403132730077.png 1.5x, C:%5cUsers%5cLiuJa%5cAppData%5cRoaming%5cTypora%5ctypora-user-images%5cimage-20230403132730077.png 2x"
        data-sizes="auto"
        alt="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403132730077.png"
        title="image-20230403132730077"></p>
<h5 id="warm-up预热--冷启动" class="headerLink">
    <a href="#warm-up%e9%a2%84%e7%83%ad--%e5%86%b7%e5%90%af%e5%8a%a8" class="header-mark"></a>Warm Up（预热 / 冷启动）</h5><ul>
<li>官网解释</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403133237912.png" alt="image-20230403133237912" style="zoom: 50%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403133329130.png" alt="image-20230403133329130" style="zoom:50%;" />
<ul>
<li>
<p>阙值除以 coldFactor（冷因子，默认值为3），经过预热时长后才会达到阙值</p>
</li>
<li>
<p>在 com.alibaba.csp.sentinel.slots.block.flow.controller.WarmUpController 中可以看到</p>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403133651292.png" alt="image-20230403133651292" style="zoom:80%;" />
<ul>
<li>默认冷加载因子为 3 ，前几秒 <code>预热时长</code> 内阈值限制在 <code>单机阈值 / 3</code> ，<code>预热时长</code> 后 阈值慢慢升高至 <code>单机阈值</code></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403135628861.png" alt="image-20230403135628861" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403141312874.png" alt="image-20230403141312874" style="zoom:80%;" />
<h5 id="匀速排队" class="headerLink">
    <a href="#%e5%8c%80%e9%80%9f%e6%8e%92%e9%98%9f" class="header-mark"></a>匀速排队</h5><img src="https://img-blog.csdnimg.cn/20200627223447141.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<img src="https://img-blog.csdnimg.cn/20200627223511665.png" alt="在这里插入图片描述" style="zoom:50%;" />
<ul>
<li>让请求以均匀的速度通过，阈值必须设为 QPS</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403141858808.png" alt="image-20230403141858808" style="zoom:80%;" />
<ul>
<li>一秒内第二次请求就处于加载状态，点多了就会看到 直接失败 页面</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403141946192.png" alt="image-20230403141946192" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403142323759.png" alt="image-20230403142323759" style="zoom:80%;" />
<h4 id="降级规则熔断降级规则" class="headerLink">
    <a href="#%e9%99%8d%e7%ba%a7%e8%a7%84%e5%88%99%e7%86%94%e6%96%ad%e9%99%8d%e7%ba%a7%e8%a7%84%e5%88%99" class="header-mark"></a>降级规则（熔断降级规则）</h4><ul>
<li>Sentinel 是没有半开状态的，要么拉闸停用，要么关闭断路器恢复（貌似新版 1.8.0 之后 加入了 Half-Open 探测恢复状态）</li>
<li>Sentinel 熔断降级会在调用链路中某个资源出现 <strong>不稳定状态</strong> 时（例如调用超市或异常比例升高）
<ul>
<li>对这个资源的调用进行 <strong>限制</strong>。让请求快速失败，避免影响其他资源而导致级联错误（默认行为抛出 DegradeException）</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403143758225.png" alt="image-20230403143758225" style="zoom: 80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403143605114.png" alt="image-20230403143605114" style="zoom: 43%;" />
<h5 id="rt-慢调用比例" class="headerLink">
    <a href="#rt-%e6%85%a2%e8%b0%83%e7%94%a8%e6%af%94%e4%be%8b" class="header-mark"></a>RT 慢调用比例</h5><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403144355117.png" alt="image-20230403144355117" style="zoom: 80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403152544347.png" alt="image-20230403152544347" style="zoom:80%;" />
<ul>
<li>添加 testD 方法，执行时间需要 1 秒</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403145404892.png" alt="image-20230403145404892" style="zoom:80%;" />
<ul>
<li>Jmeter 设置为每秒 10 个请求，永远循环</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403150204091.png" alt="image-20230403150204091" style="zoom:80%;" />
<ul>
<li>当 JMeter 进行时无法访问
<ul>
<li>这是因为在 1 秒内超过 5 个请求在 200 ms 内没有完成一次请求的处理，断路器打开，微服务不可用</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403151829832.png" alt="image-20230403151829832" style="zoom:80%;" />
<h5 id="异常比例" class="headerLink">
    <a href="#%e5%bc%82%e5%b8%b8%e6%af%94%e4%be%8b" class="header-mark"></a>异常比例</h5><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403144424933.png" alt="image-20230403144424933" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403153230336.png" alt="image-20230403153230336" style="zoom:80%;" />
<ul>
<li>修改 testD 方法，使其抛出异常</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403152808850.png" alt="image-20230403152808850" style="zoom:80%;" />
<ul>
<li>当每秒内请求大于 5 次其中有 1 次报错（0.2 &raquo; 20%），则断路器打开
<ul>
<li>当时间窗口结束，1秒后恢复正常</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403152905776.png" alt="image-20230403152905776" style="zoom:80%;" />
<h5 id="异常数" class="headerLink">
    <a href="#%e5%bc%82%e5%b8%b8%e6%95%b0" class="header-mark"></a>异常数</h5><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403144433094.png" alt="image-20230403144433094" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403154106924.png" alt="image-20230403154106924" style="zoom:80%;" />
<ul>
<li>当访问 testD 第三次及以上时，进入熔断状态 进入时间窗口期不处理请求 60秒</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403152905776.png" alt="image-20230403152905776" style="zoom:80%;" />
<h4 id="热点规则热点-key-限流" class="headerLink">
    <a href="#%e7%83%ad%e7%82%b9%e8%a7%84%e5%88%99%e7%83%ad%e7%82%b9-key-%e9%99%90%e6%b5%81" class="header-mark"></a>热点规则（热点 Key 限流）</h4><ul>
<li>热点参数限流会统计传入参数中的<strong>热点参数</strong>，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流</li>
</ul>
<img src="https://github.com/alibaba/Sentinel/wiki/image/sentinel-hot-param-overview-1.png" alt="Sentinel Parameter Flow Control" style="zoom:80%;" />
<ul>
<li>类似豪猪哥的 <code>@HystrixCommand</code> 注解，Sentinel 提供 <code>@SentinelResource</code> 实现兜底方法的设置等功能 <a id='SentinelResource'> </a>
<ul>
<li>value：资源名，和访问路径一致，去 /</li>
<li>blockHandler：兜底方法名</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/testHotKey&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;testHotKey&#34;</span><span class="o">,</span> <span class="n">blockHandler</span> <span class="o">=</span> <span class="s">&#34;deal_testHotKey&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">testHotKey</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;p1&#34;</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span><span class="n">String</span> <span class="n">p1</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                             <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;p2&#34;</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span><span class="n">String</span> <span class="n">p2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;----testHotKey&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 兜底方法                       兜底方法参数为 原方法的参数 + BlockException
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">deal_testHotKey</span><span class="o">(</span><span class="n">String</span> <span class="n">p1</span><span class="o">,</span> <span class="n">String</span> <span class="n">p2</span><span class="o">,</span> <span class="n">BlockException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// sentinel 的默认提示都是 Blocked by Sentinel (flow limiting)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="s">&#34;----deal_testHotKey, o(╥﹏╥)o&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>配置热点规则
<ul>
<li>参数索引是参数下标，从 0 开始</li>
<li>单机阈值是 QPS 的阈值，<strong>1 秒内带有第 0 个参数（也就是 p1）的请求超过 1 次，则进入其对应的兜底方法</strong></li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403164326285.png" alt="image-20230403164326285" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403163558508.png" alt="image-20230403163558508" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403163608696.png" alt="image-20230403163608696" style="zoom:80%;" />
<ul>
<li>如果没有配置 blockHandler 属性兜底方法，会直接将错误页面打到前端</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;testHotKey&#34;</span><span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403163826409.png" alt="image-20230403163826409" style="zoom:80%;" />
<h5 id="参数例外项" class="headerLink">
    <a href="#%e5%8f%82%e6%95%b0%e4%be%8b%e5%a4%96%e9%a1%b9" class="header-mark"></a>参数例外项</h5><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403165008154.png" alt="image-20230403165008154" style="zoom:80%;" />
<ul>
<li>当 p1 参数的值为 5 的时候，阈值变为 200
<ul>
<li>此时就算手速再快也很难点出 200 QPS</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230403164814764.png" alt="image-20230403164814764" style="zoom:80%;" />
<h5 id="异常情况" class="headerLink">
    <a href="#%e5%bc%82%e5%b8%b8%e6%83%85%e5%86%b5" class="header-mark"></a>异常情况</h5><ul>
<li>如果业务方法中抛出了异常，这时候并不是限流规则中的问题，运行时出错 Sentinel 不管，照常抛出异常</li>
<li><code>@SentinelResource</code> 有 fallback 参数，后续说明</li>
</ul>
<h4 id="系统规则" class="headerLink">
    <a href="#%e7%b3%bb%e7%bb%9f%e8%a7%84%e5%88%99" class="header-mark"></a>系统规则</h4><ul>
<li>官网：https://github.com/alibaba/Sentinel/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E9%99%90%E6%B5%81</li>
</ul>
<blockquote>
<p>Sentinel 系统自适应限流从 <strong>整体维度</strong> 对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
</blockquote>
<ul>
<li>
<p>应用整体维度的，而不是资源维度的，并且 <strong>仅对入口流量生效</strong></p>
<ul>
<li><strong>入口流量</strong> 指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</li>
</ul>
</li>
<li>
<p>系统规则支持以下的模式：</p>
<ul>
<li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li>
<li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
</li>
</ul>
<h5 id="全局-qps" class="headerLink">
    <a href="#%e5%85%a8%e5%b1%80-qps" class="header-mark"></a>全局 QPS</h5><ul>
<li>添加系统规则</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412162627833.png" alt="image-20230412162627833" style="zoom: 80%;" />
<ul>
<li>此时对 <code>/testA</code> 刷新次数过多，就会触发系统保护</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412162902413.png" alt="image-20230412162902413" style="zoom:80%;" />
<ul>
<li><code>/testB</code> 同理</li>
</ul>
<h4 id="sentinelresource-注解" class="headerLink">
    <a href="#sentinelresource-%e6%b3%a8%e8%a7%a3" class="header-mark"></a>@SentinelResource 注解</h4><h5 id="按-资源名称-限流--后续处理" class="headerLink">
    <a href="#%e6%8c%89-%e8%b5%84%e6%ba%90%e5%90%8d%e7%a7%b0-%e9%99%90%e6%b5%81--%e5%90%8e%e7%bb%ad%e5%a4%84%e7%90%86" class="header-mark"></a>按 资源名称 限流 + 后续处理</h5><ul>
<li>上面热点规则中就有用到 <code>@SentinelResource</code> 注解按 <strong>资源名称</strong> 限流，前往：<a href='#SentinelResource'>热点规则相关</a></li>
</ul>
<ol>
<li>编写代码</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RateLimitController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/byResource&#34;</span><span class="o">)</span> <span class="c1">// 资源名                        兜底方法名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;byResource&#34;</span><span class="o">,</span> <span class="n">blockHandler</span> <span class="o">=</span> <span class="s">&#34;handleException&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">byResource</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span> <span class="s">&#34;按照资源名称限流测试&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Payment</span><span class="o">(</span><span class="n">2020L</span><span class="o">,</span> <span class="s">&#34;serial001&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 兜底方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">handleException</span><span class="o">(</span><span class="n">BlockException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">444</span><span class="o">,</span> <span class="n">exception</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getCanonicalName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t 服务不可用&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>添加流控</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412164133730.png" alt="image-20230412164133730" style="zoom:80%;" />
<ol start="3">
<li>当出发流控规则后，进入兜底方法，此时抛出的异常为 <code>FlowException</code></li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412164306668.png" alt="image-20230412164306668" style="zoom:80%;" />
<h5 id="按照-url-地址限流--后续处理" class="headerLink">
    <a href="#%e6%8c%89%e7%85%a7-url-%e5%9c%b0%e5%9d%80%e9%99%90%e6%b5%81--%e5%90%8e%e7%bb%ad%e5%a4%84%e7%90%86" class="header-mark"></a>按照 URL 地址限流 + 后续处理</h5><ul>
<li>当使用 URL 地址限流，没有设置兜底方法，系统会使用默认的兜底方法</li>
</ul>
<ol>
<li>在 RateLimitController 中添加方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/rateLimit/byUrl&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;byUrl&#34;</span><span class="o">)</span>    <span class="c1">// 没有兜底方法，系统就用默认的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">byUrl</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span> <span class="s">&#34;按照byUrl限流测试&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Payment</span><span class="o">(</span><span class="n">2020L</span><span class="o">,</span> <span class="s">&#34;serial002&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>为 URL 添加流控</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412165210548.png" alt="image-20230412165210548" style="zoom: 80%;" />
<ol start="3">
<li>此时就算配置了 兜底方法 也不会进入，而是直接进入系统默认的兜底处理</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412165542864.png" alt="image-20230412165542864" style="zoom:80%;" />
<h5 id="遇到问题" class="headerLink">
    <a href="#%e9%81%87%e5%88%b0%e9%97%ae%e9%a2%98" class="header-mark"></a>遇到问题</h5><ul>
<li>
<p>此时又遇到了 Hystrix 豪猪哥的问题：<a href='#HystrixProblem'>豪猪哥相关</a></p>
<ul>
<li>每个业务方法都要配置一个兜底方法，导致代码膨胀【类中统一的兜底方法】</li>
<li>兜底方法和业务逻辑混在一起，导致代码混乱，耦合度高【全局的兜底方法】</li>
</ul>
<img src="https://img-blog.csdnimg.cn/2020062817164342.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
</li>
</ul>
<h5 id="自定义限流处理逻辑" class="headerLink">
    <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89%e9%99%90%e6%b5%81%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91" class="header-mark"></a>自定义限流处理逻辑</h5><ol>
<li>在 myhandler 包下创建 CustomerBlockHandler 类，用于配置统一的兜底方法，其返回值类型必须和业务方法一致</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomerBlockHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CommonResult</span> <span class="nf">handlerException</span><span class="o">(</span><span class="n">BlockException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">444</span><span class="o">,</span> <span class="s">&#34;按照客户自定义限流测试，Glogal handlerException ---- 1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CommonResult</span> <span class="nf">handlerException2</span><span class="o">(</span><span class="n">BlockException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">444</span><span class="o">,</span> <span class="s">&#34;按照客户自定义限流测试，Glogal handlerException ---- 2&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在需要用到这个统一的兜底方法的 @SentinelResource 注解中配置 <strong>blockHandlerClass</strong> 属性为上方类的 .class，并配置上方类中的 <strong>对应兜底方法</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/rateLimit/customerBlockHandler&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;customerBlockHandler&#34;</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">                      <span class="n">blockHandlerClass</span> <span class="o">=</span> <span class="n">CustomerBlockHandler</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">blockHandler</span> <span class="o">=</span> <span class="s">&#34;handlerException2&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">customerBlockHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span> <span class="s">&#34;按照客户自定义限流测试&#34;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Payment</span><span class="o">(</span><span class="n">2020L</span><span class="o">,</span> <span class="s">&#34;serial003&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此时如果出发了限流规则，就会自动进入这个统一的兜底方法</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412171139531.png" alt="image-20230412171139531" style="zoom:80%;" />
<blockquote>
<p><strong>注解配置对应内容</strong></p>
<img src="https://img-blog.csdnimg.cn/20200628173415885.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom: 50%;" />
</blockquote>
<h5 id="sentinelresource-注解其他属性" class="headerLink">
    <a href="#sentinelresource-%e6%b3%a8%e8%a7%a3%e5%85%b6%e4%bb%96%e5%b1%9e%e6%80%a7" class="header-mark"></a>@SentinelResource 注解其他属性</h5><ul>
<li>注解方式埋点不支持 private 方法</li>
</ul>
<img src="https://img-blog.csdnimg.cn/20200628174002805.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<ul>
<li>当然也可以手动配置逻辑</li>
</ul>
<img src="https://img-blog.csdnimg.cn/20200628174135795.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<ul>
<li>Sentinal 主要有三个核心 API
<ul>
<li>SphU 定义资源</li>
<li>Tracer 定义统计</li>
<li>ContextUtil 定义了上下文</li>
</ul>
</li>
</ul>
<h4 id="服务熔断" class="headerLink">
    <a href="#%e6%9c%8d%e5%8a%a1%e7%86%94%e6%96%ad" class="header-mark"></a>服务熔断</h4><ul>
<li>此处部署操作查看：<a href="https://blog.csdn.net/qq_36903261/article/details/106899215#%e6%9c%8d%e5%8a%a1%e7%86%94%e6%96%ad%e5%8a%9f%e8%83%bd" target="_blank" rel="noopener noreffer">最新的SpringCloud(H版&amp;Alibaba)技术（19高级部分，熔断与限流【Sentinel】）_小楊同学（angenin）的博客-CSDN博客</a></li>
</ul>
<h5 id="使用-resttemplate" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8-resttemplate" class="header-mark"></a>使用 RestTemplate</h5><ol>
<li>
<p>为 @SentinelResource 注解配置 <strong>fallback</strong> 属性，当抛出业务<strong>异常</strong>时调用对应兜底方法</p>
</li>
<li>
<p>为 @SentinelResource 注解配置 <strong>blockHandler</strong> 属性，当<strong>触发</strong>控制台配置的<strong>规则</strong>时调用对应兜底方法</p>
</li>
<li>
<p>如果 <strong>两者都没有配置</strong> 则直接将异常信息显示在前端 <strong>或</strong> 显示默认的兜底页面</p>
</li>
<li>
<p>如果 <strong>两者都配置了</strong> 如果同时符合，优先执行 <strong>blockHandler</strong> 兜底方法</p>
</li>
</ol>
<blockquote>
<ul>
<li>fallback 配合 exceptionToIgnore 实现指定异常不走兜底方法</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412232805582.png" alt="image-20230412232805582" style="zoom:80%;" />
</blockquote>
<h5 id="使用-feign-1" class="headerLink">
    <a href="#%e4%bd%bf%e7%94%a8-feign-1" class="header-mark"></a>使用 Feign</h5><ol>
<li>注意如果使用 Feign 配合 Sentinel 的话需要开启 Sentinel 对 Feign 的支持</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c"># 激活 Sentinel 对 Feign 的支持</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sentinel</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>用法同上 <a href='#FeignClientFallback'>Feign 的 fallback 属性</a></li>
</ol>
<h4 id="常见熔断框架比较" class="headerLink">
    <a href="#%e5%b8%b8%e8%a7%81%e7%86%94%e6%96%ad%e6%a1%86%e6%9e%b6%e6%af%94%e8%be%83" class="header-mark"></a>常见熔断框架比较</h4><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412234654343.png" alt="image-20230412234654343" style="zoom: 50%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412234718099.png" alt="image-20230412234718099" style="zoom:50%;" />
<h4 id="规则持久化" class="headerLink">
    <a href="#%e8%a7%84%e5%88%99%e6%8c%81%e4%b9%85%e5%8c%96" class="header-mark"></a>规则持久化</h4><ul>
<li>Sentinel 官方推荐持久化进 nacos</li>
</ul>
<ol>
<li>添加 POM 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">    <span class="c">&lt;!-- SpringCloud ailibaba sentinel-datasource-nacos 持久化需要用到 --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;groupId&gt;</span>com.alibaba.csp<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;artifactId&gt;</span>sentinel-datasource-nacos<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>为模块配置持久化属性 application.yml 配置：datasource&hellip;</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412235940244.png" alt="image-20230412235940244" style="zoom:80%;" />
<ol start="3">
<li>在 nacos 控制台中添加配置</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230412235553419.png" alt="image-20230412235553419" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413000108580.png" alt="image-20230413000108580" style="zoom:80%;" />
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;resource&#34;</span><span class="p">:</span> <span class="s2">&#34;/rateLimit/byUrl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;limitApp&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;grade&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;strategy&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;controlBehavior&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;clusterMode&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><img src="https://img-blog.csdnimg.cn/20200628221507808.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:50%;" />
<ol start="4">
<li>此时重启项目在流控规则中即可看到持久化的规则，并且是生效状态</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413000345235.png" alt="image-20230413000345235" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413000528377.png" alt="image-20230413000528377" style="zoom:80%;" />
<h3 id="seata-事务" class="headerLink">
    <a href="#seata-%e4%ba%8b%e5%8a%a1" class="header-mark"></a>Seata 事务</h3><ul>
<li>在分布式系统中，往往不止一个数据库</li>
<li><strong>一次业务操作需要跨多个数据源或需要跨多个系统进行远程调用，就会产生分布式事务问题</strong>，Seate 就是来<strong>保障全局数据一致性问题</strong></li>
<li>例如：商品售卖的业务逻辑被拆分成三个微服务提供支持，分配使用独立的数据库
<ul>
<li>仓储服务：对给定的商品扣除仓储数量</li>
<li>订单服务：根据采购需求创建订单</li>
<li>账户服务：从用户账户中扣除余额</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413171847731.png" alt="image-20230413171847731" style="zoom: 80%;" />
<ul>
<li>Seata 官网：<a href="https://seata.io/zh-cn/index.html" target="_blank" rel="noopener noreffer">Seata</a></li>
</ul>
<h4 id="seata-术语" class="headerLink">
    <a href="#seata-%e6%9c%af%e8%af%ad" class="header-mark"></a>Seata 术语</h4><ul>
<li><strong>一加三概念组成</strong>
<ul>
<li>一 ID：
<ul>
<li>全局唯一的事务 ID</li>
</ul>
</li>
<li>三 组件模型：
<ul>
<li><strong>TC</strong> (Transaction Coordinator) - <strong>事务协调者</strong>
<ul>
<li>维护全局和分支事务的状态，驱动全局事务提交或回滚。</li>
</ul>
</li>
<li><strong>TM</strong> (Transaction Manager) - <strong>事务管理器</strong>
<ul>
<li>定义全局事务的范围：开始全局事务、提交或回滚全局事务。</li>
</ul>
</li>
<li><strong>RM</strong> (Resource Manager) - <strong>资源管理器</strong>
<ul>
<li>管理分支事务处理的资源，与 TC 交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413173040544.png" alt="image-20230413173040544" style="zoom: 43%;" />
<ul>
<li>处理过程
<ol>
<li>TM 向 TC <strong>申请</strong>开启一个全局事务，全局事务<strong>创建</strong>成功并生成一个全局唯一的 XID</li>
<li>XID 在微服务调用链路的上下文中传播</li>
<li>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖</li>
<li>TM 向 TC 发起针对 XID 的全局提交或回滚决议</li>
<li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求</li>
</ol>
</li>
</ul>
<img src="https://img-blog.csdnimg.cn/20200629124435961.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:67%;" />
<h4 id="seata-的安装部署" class="headerLink">
    <a href="#seata-%e7%9a%84%e5%ae%89%e8%a3%85%e9%83%a8%e7%bd%b2" class="header-mark"></a>Seata 的安装部署</h4><ol>
<li>前往官网下载 Seata：<a href="https://seata.io/zh-cn/blog/download.html" target="_blank" rel="noopener noreffer">下载中心 (seata.io)</a>  这里按 0.9.0 版本为例</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413174422860.png" alt="image-20230413174422860" style="zoom:50%;" />
<ol start="2">
<li>
<p>修改 conf 目录下的 file.conf 文件</p>
<ul>
<li>修改测试事务组名称 <code>fsp_tx_group</code></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413175334883.png" alt="image-20230413175334883" style="zoom:80%;" />
<ul>
<li>修改事务日志存储模式为 <code>db</code></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413175457312.png" alt="image-20230413175457312" style="zoom:80%;" />
<ul>
<li><code>cj</code></li>
<li><code>?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</code></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413175851985.png" alt="image-20230413175851985" style="zoom:80%;" />
</li>
<li>
<p>创建数据库 <code>seata</code></p>
<ul>
<li>导入 conf 目录下的 db_store.sql</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413180157310.png" alt="image-20230413180157310" style="zoom:80%;" />
</li>
<li>
<p>修改 conf 目录下 registry.conf 注册配置文件</p>
<ul>
<li>指明注册中心为 nacos 并配置链接信息</li>
</ul>
</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413180530662.png" alt="image-20230413180530662" style="zoom:80%;" />
<ol start="5">
<li>
<p>启动 nacos</p>
</li>
<li>
<p>启动 seata</p>
<ul>
<li>进入 bin 目录，执行命令 <code>.\seata-server.bat</code> 看到报错</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413181109965.png" alt="image-20230413181109965" style="zoom:80%;" />
<ul>
<li>原因是没找到 MySQL 8 的驱动，可以手动下载驱动 jar 包放到 lib 目录下即可</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413181747118.png" alt="image-20230413181747118" style="zoom:80%;" />
</li>
</ol>
<h4 id="搭建-seata-工程" class="headerLink">
    <a href="#%e6%90%ad%e5%bb%ba-seata-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>搭建 Seata 工程</h4><img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413184845847.png" alt="image-20230413184845847" style="zoom: 80%;" />
<ul>
<li>
<p>创建三个数据库</p>
<ul>
<li>seata_order: 存储订单的数据库</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413185739214.png" alt="image-20230413185739214" style="zoom:80%;" />
<ul>
<li>seata_storage: 存储库存的数据库</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413185756084.png" alt="image-20230413185756084" style="zoom:80%;" />
<ul>
<li>seata_account: 存储账户信息的数据库</li>
</ul>
</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413185807541.png" alt="image-20230413185807541" style="zoom:80%;" />
<ul>
<li>创建对应业务表，并创建各自的 undo_log 表用于记录回滚日志【0.9.0 注意版本差异】</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="err">创建业务数据库和对应的业务表</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">order</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">seata_order</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">use</span><span class="w"> </span><span class="n">seata_order</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t_order</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;用户id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">product_id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;产品id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="k">count</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;数量&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">money</span><span class="o">`</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;金额&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">status</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;订单状态: 0:创建中; 1:已完结&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">7</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t_order</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">undo_log</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="w">     </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">   </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;branch transaction id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;global transaction id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">context</span><span class="o">`</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;undo_log context,such as serialization&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">rollback_info</span><span class="o">`</span><span class="w"> </span><span class="n">LONGBLOB</span><span class="w">     </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;rollback info&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_status</span><span class="o">`</span><span class="w">    </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">      </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;0:normal status,1:defense status&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_created</span><span class="o">`</span><span class="w">   </span><span class="n">DATETIME</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;create datetime&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_modified</span><span class="o">`</span><span class="w">  </span><span class="n">DATETIME</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;modify datetime&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">ux_undo_log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InnoDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;AT transaction mode undo table&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">storage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">seata_storage</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">use</span><span class="w"> </span><span class="n">seata_storage</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t_storage</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">product_id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;产品id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">total</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;总库存&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">used</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;已用库存&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">residue</span><span class="o">`</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;剩余库存&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">t_storage</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">product_id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">total</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">used</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">residue</span><span class="o">`</span><span class="p">)</span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;100&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;100&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_storage</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">undo_log</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="w">     </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">   </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;branch transaction id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;global transaction id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">context</span><span class="o">`</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;undo_log context,such as serialization&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">rollback_info</span><span class="o">`</span><span class="w"> </span><span class="n">LONGBLOB</span><span class="w">     </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;rollback info&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_status</span><span class="o">`</span><span class="w">    </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">      </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;0:normal status,1:defense status&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_created</span><span class="o">`</span><span class="w">   </span><span class="n">DATETIME</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;create datetime&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_modified</span><span class="o">`</span><span class="w">  </span><span class="n">DATETIME</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;modify datetime&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">ux_undo_log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InnoDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;AT transaction mode undo table&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="n">account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">seata_account</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">use</span><span class="w"> </span><span class="n">seata_account</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t_account</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;用户id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">total</span><span class="o">`</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;总额度&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">used</span><span class="o">`</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;已用余额&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">`</span><span class="n">residue</span><span class="o">`</span><span class="w"> </span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;剩余可用额度&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">t_account</span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">total</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">used</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">residue</span><span class="o">`</span><span class="p">)</span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;1000&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="s1">&#39;1000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t_account</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="o">`</span><span class="n">undo_log</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="w">     </span><span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">   </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;branch transaction id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="w">           </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;global transaction id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">context</span><span class="o">`</span><span class="w">       </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;undo_log context,such as serialization&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">rollback_info</span><span class="o">`</span><span class="w"> </span><span class="n">LONGBLOB</span><span class="w">     </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;rollback info&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_status</span><span class="o">`</span><span class="w">    </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w">      </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;0:normal status,1:defense status&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_created</span><span class="o">`</span><span class="w">   </span><span class="n">DATETIME</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;create datetime&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">`</span><span class="n">log_modified</span><span class="o">`</span><span class="w">  </span><span class="n">DATETIME</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;modify datetime&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">ux_undo_log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">branch_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InnoDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">AUTO_INCREMENT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">utf8</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="o">=</span><span class="s1">&#39;AT transaction mode undo table&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>创建 订单 模块 seata-order-service2001</li>
<li>添加 POM 依赖</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Nacos --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Seata --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-seata<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;exclusions&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;exclusion&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;groupId&gt;</span>io.seata<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="nt">&lt;artifactId&gt;</span>seata-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;/exclusion&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/exclusions&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>io.seata<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>seata-all<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>0.9.0<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Feign --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- 一般通用配置 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- MySQL --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>druid-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringBoot WEB 启动依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringBoot 测试启动依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- SpringBoot 热部署依赖 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-boot-devtools<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- lombok 注解开发 --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>配置 YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">2001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">seata-order-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">alibaba</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">seata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># 自定义事务组名称, 与 seata-server 中的对应</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">tx-service-group</span><span class="p">:</span><span class="w"> </span><span class="l">my_test_tx_group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">vgroupMapping</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># 要和 tx-service-group 的值一致</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">my_test_tx_group</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w"> </span><span class="c"># 注意此处测试好多次似乎只有使用 default 才能连接成功，要保证 seata 和项目里的 file.conf 一致</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">grouplist</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c"># seata server 的 地址配置，此处可以集群配置是个数组</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8091</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w">  </span><span class="c"># nacos 服务地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># mysql 配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">com.mysql.cj.jdbc.Driver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=GMT%2B8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">129807</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hystrix</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">io</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">seata</span><span class="p">:</span><span class="w"> </span><span class="l">info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mapperLocations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath*:mapper/*.xml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>复制 file.conf 到 resources 目录下</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413192217786.png" alt="image-20230413192217786" style="zoom:80%;" />
<ol start="5">
<li>复制 registry.conf 到 resources 目录下</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413192406681.png" alt="image-20230413192406681" style="zoom:80%;" />
<ol start="6">
<li>创建 domain.CommonResult 统一返回格式类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@NoArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">code</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">T</span> <span class="n">data</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CommonResult</span><span class="o">(</span><span class="n">Integer</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">message</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>创建 domain.Order 订单实体类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="nd">@NoArgsConstructor</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">productId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">money</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">status</span><span class="o">;</span> <span class="c1">// 订单状态 0：创建中 1：已完结
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>创建 dao.OrderDao 订单 DAO 层接口</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Mapper</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderDao</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//1 新建订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//2 修改订单状态, 从 0 改为 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;userId&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;status&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">status</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="9">
<li>创建对应 Mapper，在 resources/mapper 下创建 OrderMapper.xml</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE mapper PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34; &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&#34;com.atguigu.springcloud.dao.OrderDao&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&#34;BaseResultMap&#34;</span> <span class="na">type=</span><span class="s">&#34;com.atguigu.springcloud.domain.Order&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;id</span> <span class="na">column=</span><span class="s">&#34;id&#34;</span> <span class="na">property=</span><span class="s">&#34;id&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;BIGINT&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;user_id&#34;</span> <span class="na">property=</span><span class="s">&#34;userId&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;BIGINT&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;product_id&#34;</span> <span class="na">property=</span><span class="s">&#34;productId&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;BIGINT&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;count&#34;</span> <span class="na">property=</span><span class="s">&#34;count&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;INTEGER&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;money&#34;</span> <span class="na">property=</span><span class="s">&#34;money&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;DECIMAL&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;result</span> <span class="na">column=</span><span class="s">&#34;status&#34;</span> <span class="na">property=</span><span class="s">&#34;status&#34;</span> <span class="na">jdbcType=</span><span class="s">&#34;INTEGER&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/resultMap&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">&#34;create&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;com.atguigu.springcloud.domain.Order&#34;</span> <span class="na">useGeneratedKeys=</span><span class="s">&#34;true&#34;</span> <span class="na">keyProperty=</span><span class="s">&#34;id&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        insert into t_order(`user_id`, `product_id`, `count`, `money`, `status`)
</span></span><span class="line"><span class="cl">        values (#{userId}, #{productId}, #{count}, #{money}, 0);
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/insert&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">&#34;update&#34;</span> <span class="na">parameterType=</span><span class="s">&#34;com.atguigu.springcloud.domain.Order&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        update t_order
</span></span><span class="line"><span class="cl">        set `status` = 1
</span></span><span class="line"><span class="cl">        where `user_id` = #{userId}
</span></span><span class="line"><span class="cl">          and `status` = #{status};
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/update&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/mapper&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="10">
<li>创建 service.OrderService 业务层接口</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="11">
<li>创建 service.impl.OrderServiceImpl 业务层实现类，实现下订单业务</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderServiceImpl</span> <span class="kd">implements</span> <span class="n">OrderService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">OrderDao</span> <span class="n">orderDao</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">StorageService</span> <span class="n">storageService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountService</span> <span class="n">accountService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1 新建订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================开始新建订单&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderDao</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2 扣减库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用库存，做扣减&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">storageService</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getProductId</span><span class="o">(),</span> <span class="n">order</span><span class="o">.</span><span class="na">getCount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用库存，END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3 扣减余额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用账户，做扣钱&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountService</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">order</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用账户，END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4 修改状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================修改订单状态&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================修改订单状态，END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 5 结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单业务成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="12">
<li>第 11 步骤用到了 StorageService、AccountService 接口，需要在 service 包中创建，它们负责 Feign 连接到其它微服务接口</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// =================================================== StorageService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;seata-storage-service&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StorageService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 减库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/storage/decrease&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonResult</span> <span class="nf">decrease</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;productId&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">productId</span><span class="o">,</span> <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;count&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">count</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// =================================================== AccountService 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;seata-account-service&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 减余额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/account/decrease&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">CommonResult</span> <span class="nf">decrease</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;userId&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&#34;money&#34;</span><span class="o">)</span> <span class="n">BigDecimal</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="13">
<li>创建 controller.OrderController 控制层</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">OrderService</span> <span class="n">orderService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/order/create&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span> <span class="s">&#34;订单创建成功!&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="14">
<li>创建 config.MybatisConfig 配置类，这里的目的就是声明 @MapperScan 注解，放到主启动类上同理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@MapperScan</span><span class="o">(</span><span class="s">&#34;com.atguigu.springcloud.dao&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MybatisConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="15">
<li>创建 config.DataSourceProxyConfig 配置类，使用 Seata 对数据源进行代理</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">com.alibaba.druid.pool.DruidDataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io.seata.rm.datasource.DataSourceProxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.apache.ibatis.session.SqlSessionFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.mybatis.spring.SqlSessionFactoryBean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.io.support.PathMatchingResourcePatternResolver</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.io.support.ResourcePatternResolver</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 使用 Seata 对数据源进行代理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceProxyConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${mybatis.mapperLocations}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">mapperLocations</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;spring.datasource&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">druidDataSource</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DruidDataSource</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DataSourceProxy</span> <span class="nf">dataSourceProxy</span><span class="o">(</span><span class="n">DataSource</span> <span class="n">druidDataSource</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">DataSourceProxy</span><span class="o">(</span><span class="n">druidDataSource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SqlSessionFactory</span> <span class="nf">sqlSessionFactoryBean</span><span class="o">(</span><span class="n">DataSourceProxy</span> <span class="n">dataSourceProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SqlSessionFactoryBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SqlSessionFactoryBean</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">bean</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="n">dataSourceProxy</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResourcePatternResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PathMatchingResourcePatternResolver</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">bean</span><span class="o">.</span><span class="na">setMapperLocations</span><span class="o">(</span><span class="n">resolver</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">mapperLocations</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">bean</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="16">
<li>配置主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 取消数据源的自动创建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeataOrderMain2001</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SeataOrderMain2001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="17">
<li>
<p>参照上方步骤创建 seata-storage-service2002 存储模块</p>
<ul>
<li>
<p>复制 resources 内所有内容</p>
<ul>
<li>修改 mapper 目录中文件名及内容</li>
<li>YML 配置中的端口、微服务名、数据库</li>
</ul>
</li>
<li>
<p>复制 java 包下所有内容</p>
<ul>
<li>修改控制层类名、内容为 12 步骤中的接口对应实现</li>
<li>修改 dao 层接口内容及对应 mapper</li>
<li>更改业务层类名、实现内容</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413213056869.png" alt="image-20230413213056869" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413212957619.png" alt="image-20230413212957619" style="zoom:80%;" />
</li>
</ul>
</li>
</ol>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413213016695.png" alt="image-20230413213016695" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413213041250.png" alt="image-20230413213041250" style="zoom:80%;" />
<ol start="18">
<li>
<p>创建 seata-account-service2003 账户模块同理</p>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413214516049.png" alt="image-20230413214516049" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413214535572.png" alt="image-20230413214535572" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413214550392.png" alt="image-20230413214550392" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413214605563.png" alt="image-20230413214605563" style="zoom:80%;" />
</li>
</ol>
<ul>
<li>最终在 nacos 中可以看到四个服务</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413215232434.png" alt="image-20230413215232434" style="zoom:80%;" />
<h4 id="验证-seata-工程" class="headerLink">
    <a href="#%e9%aa%8c%e8%af%81-seata-%e5%b7%a5%e7%a8%8b" class="header-mark"></a>验证 Seata 工程</h4><ul>
<li>访问：<code>http://localhost:2001/order/create?userId=1&amp;productId=1&amp;count=10&amp;money=10</code></li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413220151599.png" alt="image-20230413220151599" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413220505366.png" alt="image-20230413220505366" style="zoom:80%;" />
<ul>
<li>可以看到数据库中数据变化</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413220220405.png" alt="image-20230413220220405" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413220240761.png" alt="image-20230413220240761" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413220254656.png" alt="image-20230413220254656" style="zoom:80%;" />
<ul>
<li>此时还没有启用事务，只是恰巧都执行成功了而已</li>
<li>修改 2003 的业务代码，添加 20 秒睡眠，Feign 默认超时时间是一秒钟，这里睡了 20 秒必然报超时异常</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">decrease</span><span class="o">(</span><span class="n">Long</span> <span class="n">userId</span><span class="o">,</span> <span class="n">BigDecimal</span> <span class="n">money</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;---&gt; AccountService中扣减账户余额&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 暂停 20 秒，模拟业务超时异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">20</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountDao</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">money</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;---&gt; AccountService中扣减账户余额完成&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>刷新接口查看效果</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413221237885.png" alt="image-20230413221237885" style="zoom:80%;" />
<ul>
<li>此时数据库中订单状态没有改变为 1 已支付状态，此时账户表余额还没有变化，但是超等一会儿 20 秒过后还是会减余额</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413221219769.png" alt="image-20230413221219769" style="zoom:80%;" />
<ul>
<li>过一了会儿，又多出来一条订单 ？？？，此时的库存表、账号表也都多出了下单这是因为【Feign 的超时重试策略】</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413221357832.png" alt="image-20230413221357832" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413221452202.png" alt="image-20230413221452202" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413221501496.png" alt="image-20230413221501496" style="zoom:80%;" />
<ul>
<li>为下订单业务添加 Seata 事务</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// name 随便命名，只要不重复即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// rollbackFor 表示哪些需要回滚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// noRollbackFor 表示哪些不需要回滚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@GlobalTransactional</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;fsp-create-order&#34;</span><span class="o">,</span> <span class="n">rollbackFor</span> <span class="o">=</span> <span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">create</span><span class="o">(</span><span class="n">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1 新建订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================开始新建订单&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderDao</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2 扣减库存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用库存，做扣减&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">storageService</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getProductId</span><span class="o">(),</span> <span class="n">order</span><span class="o">.</span><span class="na">getCount</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用库存，END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 3 扣减余额
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用账户，做扣钱&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountService</span><span class="o">.</span><span class="na">decrease</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">order</span><span class="o">.</span><span class="na">getMoney</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单微服务开始调用账户，END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 4 修改状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================修改订单状态&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">orderDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================修改订单状态，END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 5 结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;============================订单业务成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>此时依然抛出异常，但是数据库并没有变化，证明事务生效</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413222024557.png" alt="image-20230413222024557" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413222103897.png" alt="image-20230413222103897" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413222114310.png" alt="image-20230413222114310" style="zoom:80%;" />
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230413222123561.png" alt="image-20230413222123561" style="zoom:80%;" />
<h4 id="seata-原理简介" class="headerLink">
    <a href="#seata-%e5%8e%9f%e7%90%86%e7%ae%80%e4%bb%8b" class="header-mark"></a>Seata 原理简介</h4><ul>
<li>Seata：Simple Extensible Autonomous Transaction Architecture 简单可扩展的自治事务框架</li>
<li>此时来看，TC、TM、RM 这都是什么东东</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230414205157506.png" alt="image-20230414205157506" style="zoom:80%;" />
<ul>
<li>所谓 TC 就是 Seata 的服务，运行的 seata-server</li>
<li>所谓 TM 就是标识了 @GlobalTransitional 的服务，就是事务的发起方</li>
<li>所谓 RM 就是 TM 调用的各个服务以及 TM 自身，就是事务的参与方</li>
</ul>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230414205552982.png" alt="image-20230414205552982" style="zoom:80%;" />
<ul>
<li>
<p>事务是分两个阶段的</p>
<ul>
<li>
<p>一阶段：</p>
<ul>
<li>业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li>
</ul>
<blockquote>
<p>Seata 会先拦截 “业务SQL” 将需要更新的业务数据保存成 <code>before image 前置镜像</code> （各自库的 undo_log 表中）</p>
<p>之后执行 “业务SQL” 更新业务数据之后 保存成 <code>after image 后置镜像</code> 然后生成 <strong>行锁</strong> （seata 库的 lock_table 表中）</p>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230414210756334.png" alt="image-20230414210756334" style="zoom: 33%;" />
</blockquote>
</li>
<li>
<p>二阶段：</p>
<ul>
<li><strong>提交</strong> 异步化，非常快速地完成</li>
</ul>
<blockquote>
<p>当业务顺利执行提交的话，Seata 将一阶段保存的前后快照数据和行锁删掉【完成数据清理】</p>
<img src="https://img-blog.csdnimg.cn/20200630151612251.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom: 33%;" />
</blockquote>
<ul>
<li><strong>回滚</strong> 通过一阶段的回滚日志进行反向补偿</li>
</ul>
<blockquote>
<ol>
<li>
<p>校验是否存在脏写（看看有没有别人动过数据，如若出现脏写则需要转人工处理）</p>
<ul>
<li>这个校验就是比对 <code>after image 后置镜像</code> 和 当前业务相关数据 是否相同</li>
</ul>
</li>
<li>
<p>用 <code>before image 前置镜像</code> 逆向出 SQL 语句【还原业务数据】</p>
</li>
<li>
<p>删除中间数据：前后快照数据、行锁【完成数据清理】</p>
</li>
</ol>
<img src="https://img-blog.csdnimg.cn/20200630151813118.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2OTAzMjYx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述" style="zoom:38%;" />
</blockquote>
</li>
</ul>
</li>
<li>
<p>Seata 支持的模式</p>
<ul>
<li>AT 模式：无侵入自动补偿的事务模式【默认】</li>
<li>SAGA 模式：长事务的解决</li>
<li>TCC 模式：支持 TCC 模式并可与 AT 混用，灵活度更高&hellip;</li>
<li>XA 模式：为实现了 XA 接口的数据库设计的模式</li>
</ul>
</li>
</ul>
<blockquote>
<p>seata 库中 branch_table 存储各个 RM 的事务信息：各个分支 ID、XID（事务ID）、对应库、锁的 key、服务名 地址等</p>
<p>seata 库中 global_table 存储 TM 的事务信息：XID（事务ID）、开启方微服务名、事务组等</p>
<p>seata 库中 lock_table 存储各个 RM 的锁信息：锁的 key、各个分支的 XID（事务ID）、锁的库 锁的表 锁的行</p>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230414212511733.png" alt="image-20230414212511733" style="zoom: 50%;" />
<p>各个库中的 undo_log 表存储：分支 ID、XID（事务ID）、前后置镜像（rollback_info）、内容类型等</p>
</blockquote>
<img src="C:\Users\LiuJa\AppData\Roaming\Typora\typora-user-images\image-20230414213317692.png" alt="image-20230414213317692" style="zoom:50%;" />
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2023-04-14</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="分享到 微博" data-sharer="weibo" data-url="https://liujjjjn.github.io/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88/" data-title="SpringCloud自学笔记md版" data-ralateuid="6018937938"><i class="fab fa-weibo fa-fw"></i></a><a href="#" onclick="return false;" title="分享到 Evernote" data-sharer="evernote" data-url="https://liujjjjn.github.io/springcloud%E8%87%AA%E5%AD%A6%E7%AC%94%E8%AE%B0md%E7%89%88/" data-title="SpringCloud自学笔记md版"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/rms%E6%8B%9B%E8%81%98%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" class="prev" rel="prev" title="招聘管理系统项目笔记"><i class="fas fa-angle-left fa-fw"></i>招聘管理系统项目笔记</a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://liujjjjn.github.io/" target="_blank" rel="noopener noreferrer">刘嘉宁</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/fuse/fuse.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"table":{"sort":true}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>